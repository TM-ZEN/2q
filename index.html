<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1å•1ç­”å­¦ç¿’ã‚¢ãƒ—ãƒª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .app-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .app-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .subject-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .subject-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: #f8f9fa;
            color: #333;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            min-height: 60px;
            word-wrap: break-word;
        }
        
        .subject-btn:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .subject-btn.active {
            background: #667eea;
            color: white;
            border-color: #5a67d8;
        }
        
        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .app-header h1 {
                font-size: 2em;
            }
            
            .subject-selector {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .subject-btn {
                font-size: 18px;
                padding: 20px;
                min-height: 70px;
            }
            
            .generate-btn, .action-btn {
                font-size: 14px;
                padding: 10px 15px;
                margin: 5px 2px;
                display: block;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .memo-input {
                font-size: 16px;
            }
            
            .question-text {
                font-size: 16px;
            }
            
            .option-btn {
                font-size: 14px;
                padding: 12px;
            }
            
            .card {
                padding: 20px;
                margin-bottom: 15px;
            }
        }
        
        .input-section {
            margin: 20px 0;
        }
        
        .input-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
        }
        
        .memo-input {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }
        
        .memo-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .generate-btn, .action-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background 0.3s ease;
        }
        
        .generate-btn:hover, .action-btn:hover {
            background: #5a67d8;
        }
        
        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .quiz-section {
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s ease;
        }
        
        .question-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }
        
        .question-text {
            font-size: 18px;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .options {
            display: grid;
            gap: 10px;
        }
        
        .option-btn {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option-btn:hover {
            border-color: #667eea;
        }
        
        .option-btn.correct {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .option-btn.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .fill-blank-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .score-display {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            color: #555;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            color: #667eea;
            font-style: italic;
        }
        
        .management-section {
            margin-top: 30px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }
        
        .question-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .question-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            float: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header">
            <h1>ğŸ“š 1å•1ç­”å­¦ç¿’ã‚¢ãƒ—ãƒª</h1>
            <p>åŠ¹ç‡çš„ãªã‚¹ã‚­ãƒæ™‚é–“å­¦ç¿’ã§ç›®æ¨™é”æˆï¼</p>
        </div>

        <div class="card">
            <h2>ç§‘ç›®é¸æŠ</h2>
            <div class="subject-selector">
                <button class="subject-btn" data-subject="decision">æ„æ€æ±ºå®šã®ç†è«–</button>
                <button class="subject-btn" data-subject="philosophy">å…¬å…±å“²å­¦</button>
                <button class="subject-btn" data-subject="communication">å¤šè¨€èªITã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³</button>
            </div>

            <!-- å•é¡Œç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="generate-section" class="hidden">
                <div class="input-section">
                    <label for="memo-input">æˆæ¥­ãƒ¡ãƒ¢ã‚’è²¼ã‚Šä»˜ã‘ã¦å•é¡Œã‚’ç”Ÿæˆï¼š</label>
                    <textarea id="memo-input" class="memo-input" placeholder="æˆæ¥­ãƒ¡ãƒ¢ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="generate-questions" class="generate-btn">AIã§å•é¡Œç”Ÿæˆ (å®Ÿé¨“çš„)</button>
                    <button id="generate-prompt" class="generate-btn" style="background: #28a745;">Claudeç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ</button>
                    <button id="import-questions" class="generate-btn" style="background: #fd7e14;">ç”Ÿæˆæ¸ˆã¿å•é¡Œã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                </div>
                
                <div id="loading" class="loading hidden">å•é¡Œã‚’ç”Ÿæˆä¸­...</div>
                
                <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="prompt-display" class="hidden" style="margin-top: 20px;">
                    <label>ä»¥ä¸‹ã‚’Claude AIã«ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ï¼š</label>
                    <textarea id="prompt-text" class="memo-input" readonly style="background: #f8f9fa; height: 150px;"></textarea>
                    <button id="copy-prompt" class="action-btn">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
                </div>
                
                <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒªã‚¢ -->
                <div id="import-area" class="hidden" style="margin-top: 20px;">
                    <label>Claude AIã®å›ç­”ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š</label>
                    <textarea id="import-text" class="memo-input" placeholder="Claude AIãŒç”Ÿæˆã—ãŸJSONå½¢å¼ã®å•é¡Œã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>
                    <button id="process-import" class="action-btn">å•é¡Œã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                </div>
            </div>

            <!-- å­¦ç¿’ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="study-section" class="hidden">
                <div class="score-display">
                    æ­£è§£ç‡: <span id="score">0</span>/<span id="total">0</span> (<span id="percentage">0</span>%)
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <button id="start-quiz" class="action-btn">å­¦ç¿’é–‹å§‹ (15å•)</button>
                <button id="reset-progress" class="action-btn">é€²æ—ãƒªã‚»ãƒƒãƒˆ</button>
            </div>

            <!-- ã‚¯ã‚¤ã‚ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="quiz-section" class="quiz-section">
                <div class="question-card">
                    <div class="question-text" id="question-text"></div>
                    <div id="options-container"></div>
                    <input type="text" id="fill-blank-input" class="fill-blank-input hidden" placeholder="ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                    <button id="submit-answer" class="action-btn hidden">å›ç­”</button>
                    <button id="next-question" class="action-btn hidden">æ¬¡ã®å•é¡Œ</button>
                </div>
            </div>

            <!-- å•é¡Œç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="management-section" class="management-section hidden">
                <h3>å•é¡Œç®¡ç†</h3>
                <p>ä¿å­˜æ¸ˆã¿å•é¡Œæ•°: <span id="question-count">0</span></p>
                <button id="show-questions" class="action-btn">å•é¡Œä¸€è¦§è¡¨ç¤º</button>
                <button id="clear-subject-data" class="action-btn" style="background: #dc3545;">ç§‘ç›®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
                <button id="manage-api-key" class="action-btn" style="background: #6c757d;">APIã‚­ãƒ¼ç®¡ç†</button>
                <button id="debug-info" class="action-btn" style="background: #17a2b8;">ãƒ‡ãƒãƒƒã‚°æƒ…å ±</button>
                
                <!-- ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                    <h4>ğŸ“± ãƒ‡ãƒã‚¤ã‚¹é–“ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ</h4>
                    <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</label>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="user-id-input" placeholder="å…±æœ‰ç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›" style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <button id="set-user-id" class="action-btn" style="background: #6f42c1;">IDè¨­å®š</button>
                        </div>
                        <small style="color: #666; margin-top: 5px; display: block;">
                            ç¾åœ¨ã®ID: <span id="current-user-id">æœªè¨­å®š</span>
                        </small>
                    </div>
                    
                    <button id="export-data" class="action-btn" style="background: #28a745;">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button id="import-data" class="action-btn" style="background: #fd7e14;">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    <button id="save-to-cloud" class="action-btn" style="background: #007bff;">ğŸ“¤ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜</button>
                    <button id="load-from-cloud" class="action-btn" style="background: #17a2b8;">ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿</button>
                </div>
                
                <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒªã‚¢ -->
                <div id="data-import-area" class="hidden" style="margin-top: 15px;">
                    <label>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š</label>
                    <textarea id="import-data-text" class="memo-input" style="height: 100px;" placeholder="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>
                    <button id="process-data-import" class="action-btn">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                </div>
                <div id="question-list" class="question-list hidden"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabaseè¨­å®š
        const SUPABASE_URL = 'https://zayngisercbordbjzats.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpheW5naXNlcmNib3JkYmp6YXRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMTY4NzEsImV4cCI6MjA3MDg5Mjg3MX0.kRO52pBNwowL2AVdAvan2Kz8xwARrWe-52HdDTK9Qbs'; // å®Ÿéš›ã®ã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ãã ã•ã„
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDç”Ÿæˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å›ºæœ‰ï¼‰
        function getUserId() {
            let userId = localStorage.getItem('study_app_user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
                localStorage.setItem('study_app_user_id', userId);
            }
            return userId;
        }

        class StudyApp {
            constructor() {
                this.currentSubject = null;
                this.questions = [];
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.totalQuestions = 0;
                this.isAnswered = false;
                
                this.init();
            }

            init() {
                this.bindEvents();
                this.updateUI();
            }

            bindEvents() {
                // ç§‘ç›®é¸æŠ
                document.querySelectorAll('.subject-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectSubject(e.target.dataset.subject);
                    });
                });

                // å•é¡Œç”Ÿæˆ
                document.getElementById('generate-questions').addEventListener('click', () => {
                    this.generateQuestions();
                });

                // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
                document.getElementById('generate-prompt').addEventListener('click', () => {
                    this.generatePrompt();
                });

                // å•é¡Œã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                document.getElementById('import-questions').addEventListener('click', () => {
                    this.showImportArea();
                });

                // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚³ãƒ”ãƒ¼
                document.getElementById('copy-prompt').addEventListener('click', () => {
                    this.copyPrompt();
                });

                // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
                document.getElementById('process-import').addEventListener('click', () => {
                    this.processImport();
                });

                // å­¦ç¿’é–‹å§‹
                document.getElementById('start-quiz').addEventListener('click', () => {
                    this.startQuiz();
                });

                // å›ç­”é€ä¿¡
                document.getElementById('submit-answer').addEventListener('click', () => {
                    this.submitAnswer();
                });

                // æ¬¡ã®å•é¡Œ
                document.getElementById('next-question').addEventListener('click', () => {
                    this.nextQuestion();
                });

                // é€²æ—ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('reset-progress').addEventListener('click', () => {
                    this.resetProgress();
                });

                // å•é¡Œç®¡ç†
                document.getElementById('show-questions').addEventListener('click', () => {
                    this.showQuestionList();
                });

                document.getElementById('clear-subject-data').addEventListener('click', () => {
                    this.clearSubjectData();
                });

                // APIã‚­ãƒ¼ç®¡ç†
                document.getElementById('manage-api-key').addEventListener('click', () => {
                    this.manageAPIKey();
                });

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                document.getElementById('debug-info').addEventListener('click', () => {
                    this.showDebugInfo();
                });

                // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                document.getElementById('export-data').addEventListener('click', () => {
                    this.exportData();
                });

                // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                document.getElementById('import-data').addEventListener('click', () => {
                    this.showDataImportArea();
                });

                // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
                document.getElementById('process-data-import').addEventListener('click', () => {
                    this.processDataImport();
                });

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDè¨­å®š
                document.getElementById('set-user-id').addEventListener('click', () => {
                    this.setUserId();
                });

                // ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜
                document.getElementById('save-to-cloud').addEventListener('click', () => {
                    this.saveToCloud();
                });

                // ã‚¯ãƒ©ã‚¦ãƒ‰èª­ã¿è¾¼ã¿
                document.getElementById('load-from-cloud').addEventListener('click', () => {
                    this.loadFromCloud();
                });

                // Enter ã‚­ãƒ¼ã§å›ç­”é€ä¿¡
                document.getElementById('fill-blank-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.submitAnswer();
                    }
                });
            }

            selectSubject(subject) {
                this.currentSubject = subject;
                
                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
                document.querySelectorAll('.subject-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-subject="${subject}"]`).classList.add('active');

                this.loadSubjectData();
                this.updateUI();
            }

            loadSubjectData() {
                const key = `study_app_${this.currentSubject}`;
                const data = localStorage.getItem(key);
                
                if (data) {
                    const parsed = JSON.parse(data);
                    this.questions = parsed.questions || [];
                    this.score = parsed.score || 0;
                    this.totalQuestions = parsed.totalQuestions || 0;
                } else {
                    this.questions = [];
                    this.score = 0;
                    this.totalQuestions = 0;
                }
            }

            saveSubjectData() {
                const key = `study_app_${this.currentSubject}`;
                const data = {
                    questions: this.questions,
                    score: this.score,
                    totalQuestions: this.totalQuestions
                };
                localStorage.setItem(key, JSON.stringify(data));
            }

            updateUI() {
                if (!this.currentSubject) {
                    document.getElementById('generate-section').classList.add('hidden');
                    document.getElementById('study-section').classList.add('hidden');
                    document.getElementById('management-section').classList.add('hidden');
                    return;
                }

                document.getElementById('generate-section').classList.remove('hidden');
                document.getElementById('management-section').classList.remove('hidden');

                if (this.questions.length > 0) {
                    document.getElementById('study-section').classList.remove('hidden');
                    document.getElementById('score').textContent = this.score;
                    document.getElementById('total').textContent = this.totalQuestions;
                    const percentage = this.totalQuestions > 0 ? Math.round((this.score / this.totalQuestions) * 100) : 0;
                    document.getElementById('percentage').textContent = percentage;
                    
                    const progress = this.totalQuestions > 0 ? (this.score / this.totalQuestions) * 100 : 0;
                    document.getElementById('progress-fill').style.width = `${progress}%`;
                } else {
                    document.getElementById('study-section').classList.add('hidden');
                }

                document.getElementById('question-count').textContent = this.questions.length;
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDè¡¨ç¤ºæ›´æ–°
                this.updateUserIdDisplay();
            }

            updateUserIdDisplay() {
                const currentUserId = getUserId();
                document.getElementById('current-user-id').textContent = currentUserId;
            }

            async generateQuestions() {
                const memo = document.getElementById('memo-input').value.trim();
                
                if (!memo) {
                    alert('æˆæ¥­ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // APIã‚­ãƒ¼ã®ç¢ºèª
                let apiKey = localStorage.getItem('anthropic_api_key');
                if (!apiKey) {
                    apiKey = prompt('Anthropic APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»Šå¾Œã®ãŸã‚ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰:');
                    if (!apiKey) {
                        alert('APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚');
                        return;
                    }
                    localStorage.setItem('anthropic_api_key', apiKey);
                }

                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('generate-questions').disabled = true;

                try {
                    // Claude AIã§å•é¡Œç”Ÿæˆ
                    const questions = await this.callClaudeAPI(memo, apiKey);
                    
                    this.questions = questions;
                    this.saveSubjectData();
                    this.updateUI();
                    
                    document.getElementById('memo-input').value = '';
                    alert('å•é¡Œã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼');
                    
                } catch (error) {
                    console.error('API Error:', error);
                    
                    // APIã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã‚µãƒ³ãƒ—ãƒ«å•é¡Œã§ä»£æ›¿
                    if (confirm('AI APIæ¥ç¶šã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚µãƒ³ãƒ—ãƒ«å•é¡Œã§ä»£æ›¿ã—ã¾ã™ã‹ï¼Ÿ')) {
                        const sampleQuestions = this.generateSampleQuestions(memo);
                        this.questions = sampleQuestions;
                        this.saveSubjectData();
                        this.updateUI();
                        document.getElementById('memo-input').value = '';
                        alert('ã‚µãƒ³ãƒ—ãƒ«å•é¡Œã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼');
                    }
                } finally {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('generate-questions').disabled = false;
                }
            }

            generateSampleQuestions(memo) {
                // AI APIã®ä»£ã‚ã‚Šã«ã‚µãƒ³ãƒ—ãƒ«å•é¡Œã‚’ç”Ÿæˆï¼ˆå®Ÿè£…æ™‚ã¯AI APIã«ç½®ãæ›ãˆï¼‰
                const sampleQuestions = [];
                const words = memo.split(/\s+/).filter(word => word.length > 2);
                
                for (let i = 0; i < Math.min(15, words.length); i++) {
                    const word = words[i];
                    
                    if (i % 2 === 0) {
                        // é¸æŠè‚¢å•é¡Œ
                        sampleQuestions.push({
                            type: 'multiple',
                            question: `ã€Œ${word}ã€ã«ã¤ã„ã¦æ­£ã—ã„èª¬æ˜ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ`,
                            options: [
                                `${word}ã¯é‡è¦ãªæ¦‚å¿µã§ã‚ã‚‹`,
                                `${word}ã¯é–¢ä¿‚ã®ãªã„è¦ç´ ã§ã‚ã‚‹`,
                                `${word}ã¯å¤ã„ç†è«–ã§ã‚ã‚‹`,
                                `${word}ã¯é–“é•ã£ãŸè€ƒãˆæ–¹ã§ã‚ã‚‹`
                            ],
                            correctAnswer: 0
                        });
                    } else {
                        // ç©´åŸ‹ã‚å•é¡Œ
                        sampleQuestions.push({
                            type: 'fillblank',
                            question: `æˆæ¥­ã§å­¦ã‚“ã é‡è¦ãªæ¦‚å¿µã€Œ____ã€ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚`,
                            correctAnswer: word
                        });
                    }
                }
                
                return sampleQuestions;
            }

            async callClaudeAPI(memo, apiKey) {
                const apiUrl = 'https://api.anthropic.com/v1/messages';
                
                const prompt = `ä»¥ä¸‹ã®æˆæ¥­ãƒ¡ãƒ¢ã‹ã‚‰ã€15å•ã®1å•1ç­”å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
é¸æŠè‚¢å•é¡Œã¨ç©´åŸ‹ã‚å•é¡Œã‚’åŠã€…ç¨‹åº¦ã§æ··åœ¨ã•ã›ã¦ãã ã•ã„ã€‚
é¸æŠè‚¢å•é¡Œã¯4æŠã§ã€1ã¤ã®æ­£è§£ã¨3ã¤ã®é–“é•ã£ãŸé¸æŠè‚¢ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
ç©´åŸ‹ã‚å•é¡Œã¯é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç­”ãˆã¨ã—ã¦ãã ã•ã„ã€‚

æˆæ¥­ãƒ¡ãƒ¢:
${memo}

JSONã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜æ–‡ã¯ä¸è¦ï¼‰:
[
  {
    "type": "multiple",
    "question": "å•é¡Œæ–‡",
    "options": ["é¸æŠè‚¢1", "é¸æŠè‚¢2", "é¸æŠè‚¢3", "é¸æŠè‚¢4"],
    "correctAnswer": 0
  },
  {
    "type": "fillblank", 
    "question": "____ã«å…¥ã‚‹èªå¥ã¯ä½•ã§ã™ã‹ï¼Ÿ",
    "correctAnswer": "æ­£è§£ã®èªå¥"
  }
]`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-sonnet-20240229',
                        max_tokens: 4000,
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorData}`);
                }

                const data = await response.json();
                const content = data.content[0].text;
                
                // JSONã®æŠ½å‡º
                let jsonStr = content;
                const jsonMatch = content.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
                if (jsonMatch) {
                    jsonStr = jsonMatch[1];
                } else {
                    const arrayMatch = content.match(/\[[\s\S]*\]/);
                    if (arrayMatch) {
                        jsonStr = arrayMatch[0];
                    }
                }
                
                try {
                    return JSON.parse(jsonStr);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.error('Response content:', content);
                    throw new Error('Claude APIã®å¿œç­”ã‚’JSONã¨ã—ã¦è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
            }

            generatePrompt() {
                const memo = document.getElementById('memo-input').value.trim();
                
                if (!memo) {
                    alert('æˆæ¥­ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                const prompt = `ä»¥ä¸‹ã®æˆæ¥­ãƒ¡ãƒ¢ã‹ã‚‰ã€15å•ã®1å•1ç­”å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
é¸æŠè‚¢å•é¡Œã¨ç©´åŸ‹ã‚å•é¡Œã‚’åŠã€…ç¨‹åº¦ã§æ··åœ¨ã•ã›ã¦ãã ã•ã„ã€‚
é¸æŠè‚¢å•é¡Œã¯4æŠã§ã€1ã¤ã®æ­£è§£ã¨3ã¤ã®é–“é•ã£ãŸé¸æŠè‚¢ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
ç©´åŸ‹ã‚å•é¡Œã¯é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç­”ãˆã¨ã—ã¦ãã ã•ã„ã€‚

æˆæ¥­ãƒ¡ãƒ¢:
${memo}

å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜æ–‡ã‚„è¿½åŠ ã®ãƒ†ã‚­ã‚¹ãƒˆã¯ä¸€åˆ‡ä¸è¦ï¼‰:
[
  {
    "type": "multiple",
    "question": "å•é¡Œæ–‡",
    "options": ["é¸æŠè‚¢1", "é¸æŠè‚¢2", "é¸æŠè‚¢3", "é¸æŠè‚¢4"],
    "correctAnswer": 0
  },
  {
    "type": "fillblank", 
    "question": "____ã«å…¥ã‚‹èªå¥ã¯ä½•ã§ã™ã‹ï¼Ÿ",
    "correctAnswer": "æ­£è§£ã®èªå¥"
  }
]`;

                document.getElementById('prompt-text').value = prompt;
                document.getElementById('prompt-display').classList.remove('hidden');
                document.getElementById('import-area').classList.add('hidden');
            }

            copyPrompt() {
                const promptText = document.getElementById('prompt-text');
                promptText.select();
                document.execCommand('copy');
                alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼Claude AIã«è²¼ã‚Šä»˜ã‘ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
            }

            showImportArea() {
                document.getElementById('import-area').classList.remove('hidden');
                document.getElementById('prompt-display').classList.add('hidden');
            }

            processImport() {
                const importText = document.getElementById('import-text').value.trim();
                
                if (!importText) {
                    alert('Claude AIã®å›ç­”ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
                    return;
                }

                try {
                    // JSONã®æŠ½å‡ºã‚’è©¦è¡Œ
                    let jsonStr = importText;
                    
                    // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§å›²ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
                    const jsonMatch = importText.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
                    if (jsonMatch) {
                        jsonStr = jsonMatch[1];
                    } else {
                        // [ ã§å§‹ã¾ã‚Š ] ã§çµ‚ã‚ã‚‹JSONã‚’æŠ½å‡º
                        const arrayMatch = importText.match(/\[[\s\S]*\]/);
                        if (arrayMatch) {
                            jsonStr = arrayMatch[0];
                        }
                    }
                    
                    const questions = JSON.parse(jsonStr);
                    
                    // å•é¡Œå½¢å¼ã®æ¤œè¨¼
                    if (!Array.isArray(questions)) {
                        throw new Error('å•é¡Œã¯é…åˆ—å½¢å¼ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                    }
                    
                    for (const q of questions) {
                        if (!q.type || !q.question) {
                            throw new Error('å•é¡Œã«type, questionãŒå¿…è¦ã§ã™');
                        }
                        if (q.type === 'multiple' && (!q.options || !q.hasOwnProperty('correctAnswer'))) {
                            throw new Error('é¸æŠè‚¢å•é¡Œã«ã¯options, correctAnswerãŒå¿…è¦ã§ã™');
                        }
                        if (q.type === 'fillblank' && !q.correctAnswer) {
                            throw new Error('ç©´åŸ‹ã‚å•é¡Œã«ã¯correctAnswerãŒå¿…è¦ã§ã™');
                        }
                    }
                    
                    // æ—¢å­˜ã®å•é¡Œã«è¿½åŠ 
                    this.questions = [...this.questions, ...questions];
                    this.saveSubjectData();
                    this.updateUI();
                    
                    // UI ãƒªã‚»ãƒƒãƒˆ
                    document.getElementById('memo-input').value = '';
                    document.getElementById('import-text').value = '';
                    document.getElementById('import-area').classList.add('hidden');
                    document.getElementById('prompt-display').classList.add('hidden');
                    
                    alert(`${questions.length}å•ã®å•é¡Œã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼`);
                    
                } catch (error) {
                    alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}\n\nJSONå½¢å¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                    console.error('Import error:', error);
                    console.error('Import text:', importText);
                }
            }

            startQuiz() {
                this.currentQuestionIndex = 0;
                this.isAnswered = false;
                
                document.getElementById('quiz-section').style.display = 'block';
                this.showQuestion();
            }

            showQuestion() {
                if (this.currentQuestionIndex >= this.questions.length) {
                    this.endQuiz();
                    return;
                }

                const question = this.questions[this.currentQuestionIndex];
                document.getElementById('question-text').textContent = 
                    `å•é¡Œ ${this.currentQuestionIndex + 1}/${this.questions.length}: ${question.question}`;

                const optionsContainer = document.getElementById('options-container');
                const fillBlankInput = document.getElementById('fill-blank-input');
                const submitBtn = document.getElementById('submit-answer');
                const nextBtn = document.getElementById('next-question');

                // ãƒªã‚»ãƒƒãƒˆ
                optionsContainer.innerHTML = '';
                fillBlankInput.classList.add('hidden');
                submitBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
                this.isAnswered = false;

                if (question.type === 'multiple') {
                    // é¸æŠè‚¢å•é¡Œ
                    question.options.forEach((option, index) => {
                        const btn = document.createElement('button');
                        btn.className = 'option-btn';
                        btn.textContent = option;
                        btn.addEventListener('click', () => this.selectOption(index, btn));
                        optionsContainer.appendChild(btn);
                    });
                } else if (question.type === 'fillblank') {
                    // ç©´åŸ‹ã‚å•é¡Œ
                    fillBlankInput.classList.remove('hidden');
                    fillBlankInput.value = '';
                    submitBtn.classList.remove('hidden');
                }
            }

            selectOption(index, btnElement) {
                if (this.isAnswered) return;

                const question = this.questions[this.currentQuestionIndex];
                const correct = index === question.correctAnswer;

                // å…¨ã¦ã®é¸æŠè‚¢ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.style.pointerEvents = 'none';
                });

                // æ­£è§£ãƒ»ä¸æ­£è§£ã®è¡¨ç¤º
                if (correct) {
                    btnElement.classList.add('correct');
                    this.score++;
                } else {
                    btnElement.classList.add('incorrect');
                    // æ­£è§£ã‚‚è¡¨ç¤º
                    document.querySelectorAll('.option-btn')[question.correctAnswer].classList.add('correct');
                }

                this.totalQuestions++;
                this.isAnswered = true;
                this.saveSubjectData();
                this.updateUI();

                document.getElementById('next-question').classList.remove('hidden');
            }

            submitAnswer() {
                if (this.isAnswered) return;

                const userAnswer = document.getElementById('fill-blank-input').value.trim();
                const question = this.questions[this.currentQuestionIndex];

                if (!userAnswer) {
                    alert('ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                const correct = userAnswer.toLowerCase() === question.correctAnswer.toLowerCase();

                if (correct) {
                    alert('æ­£è§£ï¼');
                    this.score++;
                } else {
                    alert(`ä¸æ­£è§£ã€‚æ­£è§£ã¯ã€Œ${question.correctAnswer}ã€ã§ã™ã€‚`);
                }

                this.totalQuestions++;
                this.isAnswered = true;
                this.saveSubjectData();
                this.updateUI();

                document.getElementById('submit-answer').classList.add('hidden');
                document.getElementById('next-question').classList.remove('hidden');
            }

            nextQuestion() {
                this.currentQuestionIndex++;
                this.showQuestion();
            }

            endQuiz() {
                document.getElementById('quiz-section').style.display = 'none';
                const percentage = Math.round((this.score / this.totalQuestions) * 100);
                alert(`å­¦ç¿’å®Œäº†ï¼æ­£è§£ç‡: ${percentage}%`);
            }

            resetProgress() {
                if (confirm('é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                    this.score = 0;
                    this.totalQuestions = 0;
                    this.saveSubjectData();
                    this.updateUI();
                }
            }

            showQuestionList() {
                const listElement = document.getElementById('question-list');
                
                if (listElement.classList.contains('hidden')) {
                    listElement.innerHTML = '';
                    this.questions.forEach((q, index) => {
                        const item = document.createElement('div');
                        item.className = 'question-item';
                        item.innerHTML = `
                            <strong>Q${index + 1}:</strong> ${q.question}
                            <button class="delete-btn" onclick="app.deleteQuestion(${index})">å‰Šé™¤</button>
                        `;
                        listElement.appendChild(item);
                    });
                    listElement.classList.remove('hidden');
                } else {
                    listElement.classList.add('hidden');
                }
            }

            deleteQuestion(index) {
                if (confirm('ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    this.questions.splice(index, 1);
                    this.saveSubjectData();
                    this.updateUI();
                    this.showQuestionList();
                }
            }

            clearSubjectData() {
                if (confirm(`${this.currentSubject}ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    const key = `study_app_${this.currentSubject}`;
                    localStorage.removeItem(key);
                    this.questions = [];
                    this.score = 0;
                    this.totalQuestions = 0;
                    this.updateUI();
                    document.getElementById('question-list').classList.add('hidden');
                }
            }

            manageAPIKey() {
                const currentKey = localStorage.getItem('anthropic_api_key');
                let message = 'Anthropic APIã‚­ãƒ¼ç®¡ç†\n\n';
                
                if (currentKey) {
                    message += `ç¾åœ¨ã®ã‚­ãƒ¼: ${currentKey.substring(0, 10)}...\n\n`;
                    message += '1. æ–°ã—ã„ã‚­ãƒ¼ã‚’å…¥åŠ›\n2. ã‚­ãƒ¼ã‚’å‰Šé™¤\n3. ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
                    
                    const choice = prompt(message + '\n\né¸æŠã—ã¦ãã ã•ã„ (1/2/3):');
                    
                    if (choice === '1') {
                        const newKey = prompt('æ–°ã—ã„Anthropic APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                        if (newKey) {
                            localStorage.setItem('anthropic_api_key', newKey);
                            alert('APIã‚­ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
                        }
                    } else if (choice === '2') {
                        if (confirm('APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                            localStorage.removeItem('anthropic_api_key');
                            alert('APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
                        }
                    }
                } else {
                    const newKey = prompt('Anthropic APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                    if (newKey) {
                        localStorage.setItem('anthropic_api_key', newKey);
                        alert('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                    }
                }
            }

            showDebugInfo() {
                const apiKey = localStorage.getItem('anthropic_api_key');
                
                let debug = '=== ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===\n\n';
                debug += `ç¾åœ¨ã®ç§‘ç›®: ${this.currentSubject || 'ãªã—'}\n`;
                debug += `APIã‚­ãƒ¼: ${apiKey ? `è¨­å®šæ¸ˆã¿ (${apiKey.substring(0, 10)}...)` : 'æœªè¨­å®š'}\n`;
                debug += `å•é¡Œæ•°: ${this.questions.length}\n`;
                debug += `æ­£è§£/ç·å•é¡Œ: ${this.score}/${this.totalQuestions}\n`;
                debug += `ç”»é¢å¹…: ${window.innerWidth}px\n`;
                debug += `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: ${navigator.userAgent.includes('Mobile') ? 'ãƒ¢ãƒã‚¤ãƒ«' : 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—'}\n\n`;
                
                debug += '=== UIè¡¨ç¤ºçŠ¶æ…‹ ===\n';
                debug += `generate-section: ${document.getElementById('generate-section').classList.contains('hidden') ? 'éè¡¨ç¤º' : 'è¡¨ç¤º'}\n`;
                debug += `study-section: ${document.getElementById('study-section').classList.contains('hidden') ? 'éè¡¨ç¤º' : 'è¡¨ç¤º'}\n`;
                debug += `management-section: ${document.getElementById('management-section').classList.contains('hidden') ? 'éè¡¨ç¤º' : 'è¡¨ç¤º'}\n\n`;
                
                debug += '=== LocalStorageå†…å®¹ ===\n';
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    if (key.startsWith('study_app_') || key === 'anthropic_api_key') {
                        debug += `${key}: ${value ? 'è¨­å®šæ¸ˆã¿' : 'ç©º'}\n`;
                    }
                }
                
                alert(debug);
            }

            // Supabaseé–¢é€£ãƒ¡ã‚½ãƒƒãƒ‰

            async saveToCloud() {
                try {
                    const button = document.getElementById('save-to-cloud');
                    button.disabled = true;
                    button.textContent = 'ä¿å­˜ä¸­...';

                    const userId = getUserId();
                    let savedCount = 0;

                    // å…¨ç§‘ç›®ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜
                    for (const subject of ['decision', 'philosophy', 'communication']) {
                        const key = `study_app_${subject}`;
                        const localData = localStorage.getItem(key);
                        
                        if (localData) {
                            const parsedData = JSON.parse(localData);
                            
                            // å•é¡ŒãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ä¿å­˜
                            if (parsedData.questions && parsedData.questions.length > 0) {
                                const data = {
                                    user_id: userId,
                                    subject: subject,
                                    questions: parsedData.questions,
                                    score: parsedData.score || 0,
                                    total_questions: parsedData.totalQuestions || 0,
                                    updated_at: new Date().toISOString()
                                };

                                const { error } = await supabase
                                    .from('study_data')
                                    .upsert(data, { onConflict: 'user_id,subject' });

                                if (error) throw error;
                                savedCount++;
                            }
                        }
                    }

                    alert(`ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜å®Œäº†ï¼${savedCount}ç§‘ç›®ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`);

                } catch (error) {
                    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                } finally {
                    const button = document.getElementById('save-to-cloud');
                    button.disabled = false;
                    button.textContent = 'ğŸ“¤ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜';
                }
            }

            async loadFromCloud() {
                try {
                    const button = document.getElementById('load-from-cloud');
                    button.disabled = true;
                    button.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';

                    const userId = getUserId();
                    const { data, error } = await supabase
                        .from('study_data')
                        .select('*')
                        .eq('user_id', userId);

                    if (error) throw error;

                    if (data.length === 0) {
                        alert('ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\nå…ˆã«ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã€ŒğŸ“¤ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    // LocalStorage ã«ä¿å­˜
                    data.forEach(item => {
                        const key = `study_app_${item.subject}`;
                        const localData = {
                            questions: item.questions || [],
                            score: item.score || 0,
                            totalQuestions: item.total_questions || 0
                        };
                        localStorage.setItem(key, JSON.stringify(localData));
                    });

                    // ç¾åœ¨ã®ç§‘ç›®ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    if (this.currentSubject) {
                        this.loadSubjectData();
                        this.updateUI();
                    }

                    alert(`ã‚¯ãƒ©ã‚¦ãƒ‰èª­ã¿è¾¼ã¿å®Œäº†ï¼${data.length}ç§‘ç›®ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚\n\nç§‘ç›®ã‚’é¸æŠã—ã¦å­¦ç¿’ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚`);

                } catch (error) {
                    console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    alert('èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                } finally {
                    const button = document.getElementById('load-from-cloud');
                    button.disabled = false;
                    button.textContent = 'ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿';
                }
            }

            exportData() {
                const allData = {
                    exportDate: new Date().toISOString().split('T')[0],
                    userId: getUserId(),
                    subjects: {}
                };

                ['decision', 'philosophy', 'communication'].forEach(subject => {
                    const key = `study_app_${subject}`;
                    const data = localStorage.getItem(key);
                    if (data) {
                        allData.subjects[subject] = JSON.parse(data);
                    }
                });

                const jsonStr = JSON.stringify(allData, null, 2);
                
                // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                navigator.clipboard.writeText(jsonStr).then(() => {
                    alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã€Œãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
                }).catch(() => {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¡¨ç¤º
                    const textarea = document.createElement('textarea');
                    textarea.value = jsonStr;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã€Œãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
                });
            }

            showDataImportArea() {
                document.getElementById('data-import-area').classList.remove('hidden');
            }

            processDataImport() {
                const importText = document.getElementById('import-data-text').value.trim();
                
                if (!importText) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
                    return;
                }

                try {
                    const data = JSON.parse(importText);
                    
                    if (!data.subjects) {
                        throw new Error('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
                    }

                    // LocalStorageã«ä¿å­˜
                    Object.entries(data.subjects).forEach(([subject, subjectData]) => {
                        const key = `study_app_${subject}`;
                        localStorage.setItem(key, JSON.stringify(subjectData));
                    });

                    // ç¾åœ¨ã®ç§‘ç›®ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    if (this.currentSubject) {
                        this.loadSubjectData();
                        this.updateUI();
                    }

                    document.getElementById('import-data-text').value = '';
                    document.getElementById('data-import-area').classList.add('hidden');
                    
                    alert(`ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼${Object.keys(data.subjects).length}ç§‘ç›®ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚`);
                    
                } catch (error) {
                    alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            }

            setUserId() {
                const newUserId = document.getElementById('user-id-input').value.trim();
                
                if (!newUserId) {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // IDå½¢å¼ã®ç°¡å˜ãªæ¤œè¨¼
                if (newUserId.length < 3) {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯3æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                if (!/^[a-zA-Z0-9_-]+$/.test(newUserId)) {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯è‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚');
                    return;
                }

                const currentUserId = localStorage.getItem('study_app_user_id');
                
                if (currentUserId && currentUserId !== newUserId) {
                    if (!confirm(`ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€Œ${currentUserId}ã€ã‚’ã€Œ${newUserId}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ\n\næ³¨æ„: å¤‰æ›´å¾Œã¯ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã§ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`)) {
                        return;
                    }
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDè¨­å®š
                localStorage.setItem('study_app_user_id', newUserId);
                this.updateUserIdDisplay();
                document.getElementById('user-id-input').value = '';

                alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ã€Œ${newUserId}ã€ã«è¨­å®šã—ã¾ã—ãŸï¼\n\nä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã‚‚åŒã˜IDã‚’è¨­å®šã—ã¦ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã‚’è¡Œã£ã¦ãã ã•ã„ã€‚`);
            }
        }

        // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
        const app = new StudyApp();
    </script>
</body>
</html>
