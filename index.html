<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1Âïè1Á≠îÂ≠¶Áøí„Ç¢„Éó„É™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .app-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .app-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .subject-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .subject-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: #f8f9fa;
            color: #333;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            min-height: 60px;
            word-wrap: break-word;
        }
        
        .subject-btn:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .subject-btn.active {
            background: #667eea;
            color: white;
            border-color: #5a67d8;
        }
        
        .chapter-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .chapter-btn {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            min-height: 50px;
            display: flex;
            align-items: center;
            flex-direction: column;
            justify-content: center;
        }
        
        .chapter-btn:hover {
            border-color: #667eea;
            background: #e9ecef;
        }
        
        .chapter-btn.selected {
            background: #667eea;
            color: white;
            border-color: #5a67d8;
        }
        
        .chapter-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .chapter-btn.selected .chapter-info {
            color: #e0e6ff;
        }
        
        /* „É¢„Éê„Ç§„É´ÂØæÂøú */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .app-header h1 {
                font-size: 2em;
            }
            
            .subject-selector {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .subject-btn {
                font-size: 18px;
                padding: 20px;
                min-height: 70px;
            }
            
            .chapter-selector {
                grid-template-columns: 1fr;
            }
            
            .generate-btn, .action-btn {
                font-size: 14px;
                padding: 10px 15px;
                margin: 5px 2px;
                display: block;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .memo-input {
                font-size: 16px;
            }
            
            .question-text {
                font-size: 16px;
            }
            
            .option-btn {
                font-size: 14px;
                padding: 12px;
            }
            
            .card {
                padding: 20px;
                margin-bottom: 15px;
            }
        }
        
        .input-section {
            margin: 20px 0;
        }
        
        .input-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
        }
        
        .memo-input {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }
        
        .memo-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .generate-btn, .action-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background 0.3s ease;
        }
        
        .generate-btn:hover, .action-btn:hover {
            background: #5a67d8;
        }
        
        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .quiz-section {
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s ease;
        }
        
        .question-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }
        
        .question-text {
            font-size: 18px;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .options {
            display: grid;
            gap: 10px;
        }
        
        .option-btn {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option-btn:hover {
            border-color: #667eea;
        }
        
        .option-btn.correct {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .option-btn.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .fill-blank-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .score-display {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            color: #555;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            color: #667eea;
            font-style: italic;
        }
        
        .management-section {
            margin-top: 30px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }
        
        .question-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .question-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            float: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header">
            <h1>üìö 1Âïè1Á≠îÂ≠¶Áøí„Ç¢„Éó„É™</h1>
            <p>ÂäπÁéáÁöÑ„Å™„Çπ„Ç≠„ÉûÊôÇÈñìÂ≠¶Áøí„ÅßÁõÆÊ®ôÈÅîÊàêÔºÅ</p>
        </div>

        <div class="card">
            <h2>Â≠¶ÁøíË®≠ÂÆö</h2>
            
            <!-- ÁßëÁõÆÈÅ∏Êäû -->
            <h3>ÁßëÁõÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
            <div class="subject-selector">
                <button class="subject-btn" data-subject="decision">ÊÑèÊÄùÊ±∫ÂÆö„ÅÆÁêÜË´ñ</button>
                <button class="subject-btn" data-subject="philosophy">ÂÖ¨ÂÖ±Âì≤Â≠¶</button>
                <button class="subject-btn" data-subject="communication">Â§öË®ÄË™ûIT„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥</button>
            </div>

            <!-- „ÉÅ„É£„Éó„Çø„ÉºÈÅ∏Êäû -->
            <div id="chapter-section" class="hidden" style="margin-top: 20px;">
                <h3>Â≠¶Áøí„Åô„Çã„ÉÅ„É£„Éó„Çø„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ</h3>
                <div id="chapter-selector" class="chapter-selector">
                    <!-- „ÉÅ„É£„Éó„Çø„Éº„Éú„Çø„É≥„ÅåÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                </div>
                <div style="margin-top: 15px;">
                    <button id="select-all-chapters" class="action-btn" style="background: #28a745;">„Åô„Åπ„Å¶ÈÅ∏Êäû</button>
                    <button id="deselect-all-chapters" class="action-btn" style="background: #dc3545;">ÈÅ∏ÊäûËß£Èô§</button>
                </div>
            </div>

            <!-- ÂïèÈ°åÁîüÊàê„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div id="generate-section" class="hidden">
                <h3>ÂïèÈ°åÁîüÊàê</h3>
                <div class="input-section">
                    <label for="chapter-name-input">„ÉÅ„É£„Éó„Çø„ÉºÂêç:</label>
                    <input type="text" id="chapter-name-input" class="memo-input" style="height: 40px;" placeholder="‰æã: 1, 2, 3">
                </div>
                <div class="input-section">
                    <label for="memo-input">ÊéàÊ•≠„É°„É¢„ÇíË≤º„Çä‰ªò„Åë„Å¶ÂïèÈ°å„ÇíÁîüÊàêÔºö</label>
                    <textarea id="memo-input" class="memo-input" placeholder="ÊéàÊ•≠„É°„É¢„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="generate-questions" class="generate-btn">AI„ÅßÂïèÈ°åÁîüÊàê (ÂÆüÈ®ìÁöÑ)</button>
                    <button id="generate-prompt" class="generate-btn" style="background: #28a745;">ClaudeÁî®„Éó„É≠„É≥„Éó„ÉàÁîüÊàê</button>
                    <button id="import-questions" class="generate-btn" style="background: #fd7e14;">ÁîüÊàêÊ∏à„ÅøÂïèÈ°å„Ç§„É≥„Éù„Éº„Éà</button>
                </div>
                
                <div id="loading" class="loading hidden">ÂïèÈ°å„ÇíÁîüÊàê‰∏≠...</div>
                
                <!-- „Éó„É≠„É≥„Éó„ÉàË°®Á§∫„Ç®„É™„Ç¢ -->
                <div id="prompt-display" class="hidden" style="margin-top: 20px;">
                    <label>‰ª•‰∏ã„ÇíClaude AI„Å´„Ç≥„Éî„Éö„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö</label>
                    <textarea id="prompt-text" class="memo-input" readonly style="background: #f8f9fa; height: 150px;"></textarea>
                    <button id="copy-prompt" class="action-btn">„Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº</button>
                </div>
                
                <!-- „Ç§„É≥„Éù„Éº„Éà„Ç®„É™„Ç¢ -->
                <div id="import-area" class="hidden" style="margin-top: 20px;">
                    <label>Claude AI„ÅÆÂõûÁ≠î„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑÔºö</label>
                    <textarea id="import-text" class="memo-input" placeholder="Claude AI„ÅåÁîüÊàê„Åó„ÅüJSONÂΩ¢Âºè„ÅÆÂïèÈ°å„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                    <button id="process-import" class="action-btn">ÂïèÈ°å„Çí„Ç§„É≥„Éù„Éº„Éà</button>
                </div>
            </div>

            <!-- Â≠¶Áøí„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div id="study-section" class="hidden">
                <div class="score-display">
                    Ê≠£Ëß£Áéá: <span id="score">0</span>/<span id="total">0</span> (<span id="percentage">0</span>%)
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <button id="start-quiz" class="action-btn">Â≠¶ÁøíÈñãÂßã (15Âïè)</button>
                <button id="reset-progress" class="action-btn">ÈÄ≤Êçó„É™„Çª„ÉÉ„Éà</button>
            </div>

            <!-- „ÇØ„Ç§„Ç∫„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div id="quiz-section" class="quiz-section">
                <div class="question-card">
                    <div class="question-text" id="question-text"></div>
                    <div id="options-container"></div>
                    <input type="text" id="fill-blank-input" class="fill-blank-input hidden" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
                    <button id="submit-answer" class="action-btn hidden">ÂõûÁ≠î</button>
                    <button id="next-question" class="action-btn hidden">Ê¨°„ÅÆÂïèÈ°å</button>
                </div>
            </div>

            <!-- ÂïèÈ°åÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div id="management-section" class="management-section hidden">
                <h3>ÂïèÈ°åÁÆ°ÁêÜ</h3>
                <p>‰øùÂ≠òÊ∏à„ÅøÂïèÈ°åÊï∞: <span id="question-count">0</span></p>
                <button id="show-questions" class="action-btn">ÂïèÈ°å‰∏ÄË¶ßË°®Á§∫</button>
                <button id="clear-subject-data" class="action-btn" style="background: #dc3545;">ÁßëÁõÆ„Éá„Éº„ÇøÂâäÈô§</button>
                <button id="manage-api-key" class="action-btn" style="background: #6c757d;">API„Ç≠„ÉºÁÆ°ÁêÜ</button>
                <button id="debug-info" class="action-btn" style="background: #17a2b8;">„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±</button>
                
                <!-- „Éá„Éº„ÇøÁßªË°å„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                    <h4>üì± „Éá„Éê„Ç§„ÇπÈñì„Éá„Éº„ÇøÁßªË°å</h4>
                    <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">„É¶„Éº„Ç∂„ÉºID:</label>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="user-id-input" placeholder="ÂÖ±ÊúâÁî®„ÅÆ„É¶„Éº„Ç∂„ÉºID„ÇíÂÖ•Âäõ" style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <button id="set-user-id" class="action-btn" style="background: #6f42c1;">IDË®≠ÂÆö</button>
                        </div>
                        <small style="color: #666; margin-top: 5px; display: block;">
                            ÁèæÂú®„ÅÆID: <span id="current-user-id">Êú™Ë®≠ÂÆö</span>
                        </small>
                    </div>
                    
                    <button id="export-data" class="action-btn" style="background: #28a745;">üìã „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                    <button id="import-data" class="action-btn" style="background: #fd7e14;">üìã „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà</button>
                    <button id="save-to-cloud" class="action-btn" style="background: #007bff;">üì§ „ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò</button>
                    <button id="load-from-cloud" class="action-btn" style="background: #17a2b8;">üì• „ÇØ„É©„Ç¶„Éâ„Åã„ÇâË™≠„ÅøËæº„Åø</button>
                </div>
                
                <!-- „Ç§„É≥„Éù„Éº„Éà„Ç®„É™„Ç¢ -->
                <div id="data-import-area" class="hidden" style="margin-top: 15px;">
                    <label>„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åü„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑÔºö</label>
                    <textarea id="import-data-text" class="memo-input" style="height: 100px;" placeholder="„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åü„Éá„Éº„Çø„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                    <button id="process-data-import" class="action-btn">„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà</button>
                </div>
                <div id="question-list" class="question-list hidden"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // SupabaseË®≠ÂÆö
        const SUPABASE_URL = 'https://zayngisercbordbjzats.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpheW5naXNlcmNib3JkYmp6YXRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMTY4NzEsImV4cCI6MjA3MDg5Mjg3MX0.kRO52pBNwowL2AVdAvan2Kz8xwARrWe-52HdDTK9Qbs'; // ÂÆüÈöõ„ÅÆ„Ç≠„Éº„Å´ÁΩÆ„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // „ÉÜ„Éº„Éñ„É´ÊßãÈÄ†„ÇíÊñ∞„Åó„ÅÑ„ÇÇ„ÅÆ„Å´Êõ¥Êñ∞
        async function updateTableStructure() {
            try {
                // „ÉÅ„É£„Éó„Çø„ÉºÂàó„ÇíËøΩÂä†ÔºàÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
                await supabase.rpc('exec', { 
                    sql: `
                        ALTER TABLE study_data 
                        ADD COLUMN IF NOT EXISTS chapter text;
                        
                        -- Ë§áÂêà„É¶„Éã„Éº„ÇØÂà∂Á¥Ñ„ÇíÊõ¥Êñ∞
                        DROP INDEX IF EXISTS study_data_user_id_subject_key;
                        CREATE UNIQUE INDEX IF NOT EXISTS study_data_user_id_subject_chapter_key 
                        ON study_data(user_id, subject, chapter);
                    `
                });
            } catch (error) {
                console.log('„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞Ê∏à„Åø„Åæ„Åü„ÅØ„Ç®„É©„Éº:', error);
            }
        }
        
        // ÂàùÂõûÂÆüË°å
        updateTableStructure();
        
        // „É¶„Éº„Ç∂„ÉºIDÁîüÊàêÔºà„Éñ„É©„Ç¶„Ç∂Âõ∫ÊúâÔºâ
        function getUserId() {
            let userId = localStorage.getItem('study_app_user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
                localStorage.setItem('study_app_user_id', userId);
            }
            return userId;
        }

        class StudyApp {
            constructor() {
                this.currentSubject = null;
                this.selectedChapters = []; // ÈÅ∏Êäû„Åï„Çå„Åü„ÉÅ„É£„Éó„Çø„Éº
                this.allChapters = {}; // ÁßëÁõÆ„Åî„Å®„ÅÆ„ÉÅ„É£„Éó„Çø„ÉºÊÉÖÂ†±
                this.questions = [];
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.totalQuestions = 0;
                this.isAnswered = false;
                
                this.init();
            }

            init() {
                this.bindEvents();
                this.updateUI();
            }

            bindEvents() {
                // ÁßëÁõÆÈÅ∏Êäû
                document.querySelectorAll('.subject-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectSubject(e.target.dataset.subject);
                    });
                });

                // „ÉÅ„É£„Éó„Çø„ÉºÂÖ®ÈÅ∏Êäû/Ëß£Èô§
                document.getElementById('select-all-chapters').addEventListener('click', () => {
                    this.selectAllChapters();
                });

                document.getElementById('deselect-all-chapters').addEventListener('click', () => {
                    this.deselectAllChapters();
                });

                // ÂïèÈ°åÁîüÊàê
                document.getElementById('generate-questions').addEventListener('click', () => {
                    this.generateQuestions();
                });

                // „Éó„É≠„É≥„Éó„ÉàÁîüÊàê
                document.getElementById('generate-prompt').addEventListener('click', () => {
                    this.generatePrompt();
                });

                // ÂïèÈ°å„Ç§„É≥„Éù„Éº„Éà
                document.getElementById('import-questions').addEventListener('click', () => {
                    this.showImportArea();
                });

                // „Éó„É≠„É≥„Éó„Éà„Ç≥„Éî„Éº
                document.getElementById('copy-prompt').addEventListener('click', () => {
                    this.copyPrompt();
                });

                // „Ç§„É≥„Éù„Éº„ÉàÂá¶ÁêÜ
                document.getElementById('process-import').addEventListener('click', () => {
                    this.processImport();
                });

                // Â≠¶ÁøíÈñãÂßã
                document.getElementById('start-quiz').addEventListener('click', () => {
                    this.startQuiz();
                });

                // ÂõûÁ≠îÈÄÅ‰ø°
                document.getElementById('submit-answer').addEventListener('click', () => {
                    this.submitAnswer();
                });

                // Ê¨°„ÅÆÂïèÈ°å
                document.getElementById('next-question').addEventListener('click', () => {
                    this.nextQuestion();
                });

                // ÈÄ≤Êçó„É™„Çª„ÉÉ„Éà
                document.getElementById('reset-progress').addEventListener('click', () => {
                    this.resetProgress();
                });

                // ÂïèÈ°åÁÆ°ÁêÜ
                document.getElementById('show-questions').addEventListener('click', () => {
                    this.showQuestionList();
                });

                document.getElementById('clear-subject-data').addEventListener('click', () => {
                    this.clearSubjectData();
                });

                // API„Ç≠„ÉºÁÆ°ÁêÜ
                document.getElementById('manage-api-key').addEventListener('click', () => {
                    this.manageAPIKey();
                });

                // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±
                document.getElementById('debug-info').addEventListener('click', () => {
                    this.showDebugInfo();
                });

                // „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                document.getElementById('export-data').addEventListener('click', () => {
                    this.exportData();
                });

                // „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà
                document.getElementById('import-data').addEventListener('click', () => {
                    this.showDataImportArea();
                });

                // „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„ÉàÂá¶ÁêÜ
                document.getElementById('process-data-import').addEventListener('click', () => {
                    this.processDataImport();
                });

                // „É¶„Éº„Ç∂„ÉºIDË®≠ÂÆö
                document.getElementById('set-user-id').addEventListener('click', () => {
                    this.setUserId();
                });

                // „ÇØ„É©„Ç¶„Éâ‰øùÂ≠ò
                document.getElementById('save-to-cloud').addEventListener('click', () => {
                    this.saveToCloud();
                });

                // „ÇØ„É©„Ç¶„ÉâË™≠„ÅøËæº„Åø
                document.getElementById('load-from-cloud').addEventListener('click', () => {
                    this.loadFromCloud();
                });

                // Enter „Ç≠„Éº„ÅßÂõûÁ≠îÈÄÅ‰ø°
                document.getElementById('fill-blank-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.submitAnswer();
                    }
                });
            }

            selectSubject(subject) {
                this.currentSubject = subject;
                this.selectedChapters = []; // „ÉÅ„É£„Éó„Çø„ÉºÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
                
                // „Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
                document.querySelectorAll('.subject-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-subject="${subject}"]`).classList.add('active');

                this.loadChaptersForSubject(subject);
                this.updateUI();
            }

            async loadChaptersForSubject(subject) {
                try {
                    // Supabase„Åã„ÇâË©≤ÂΩìÁßëÁõÆ„ÅÆ„ÉÅ„É£„Éó„Çø„Éº‰∏ÄË¶ß„ÇíÂèñÂæó
                    const userId = getUserId();
                    const { data, error } = await supabase
                        .from('study_data')
                        .select('chapter, questions, score, total_questions')
                        .eq('user_id', userId)
                        .eq('subject', subject)
                        .not('chapter', 'is', null);

                    if (error) throw error;

                    // „ÉÅ„É£„Éó„Çø„ÉºÊÉÖÂ†±„ÇíÊï¥ÁêÜ
                    this.allChapters[subject] = data || [];
                    this.displayChapterSelector();
                    
                } catch (error) {
                    console.error('„ÉÅ„É£„Éó„Çø„ÉºË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    this.allChapters[subject] = [];
                    this.displayChapterSelector();
                }
            }

            displayChapterSelector() {
                const chapterSection = document.getElementById('chapter-section');
                const chapterSelector = document.getElementById('chapter-selector');
                
                if (!this.currentSubject) {
                    chapterSection.classList.add('hidden');
                    return;
                }

                const chapters = this.allChapters[this.currentSubject] || [];
                
                if (chapters.length === 0) {
                    chapterSection.classList.add('hidden');
                    return;
                }

                chapterSection.classList.remove('hidden');
                chapterSelector.innerHTML = '';

                chapters.forEach(chapterData => {
                    const btn = document.createElement('button');
                    btn.className = 'chapter-btn';
                    btn.dataset.chapter = chapterData.chapter;
                    
                    const questionCount = chapterData.questions ? chapterData.questions.length : 0;
                    const score = chapterData.score || 0;
                    const total = chapterData.total_questions || 0;
                    const percentage = total > 0 ? Math.round((score / total) * 100) : 0;
                    
                    btn.innerHTML = `
                        <div style="font-weight: bold;">„ÉÅ„É£„Éó„Çø„Éº ${chapterData.chapter}</div>
                        <div class="chapter-info">ÂïèÈ°åÊï∞: ${questionCount} | Ê≠£Ëß£Áéá: ${percentage}%</div>
                    `;
                    
                    btn.addEventListener('click', () => {
                        this.toggleChapter(chapterData.chapter);
                    });
                    
                    chapterSelector.appendChild(btn);
                });
            }

            toggleChapter(chapter) {
                const index = this.selectedChapters.indexOf(chapter);
                if (index > -1) {
                    this.selectedChapters.splice(index, 1);
                } else {
                    this.selectedChapters.push(chapter);
                }
                
                this.updateChapterButtonStates();
                this.loadSelectedChaptersData();
                this.updateUI();
            }

            selectAllChapters() {
                const chapters = this.allChapters[this.currentSubject] || [];
                this.selectedChapters = chapters.map(c => c.chapter);
                this.updateChapterButtonStates();
                this.loadSelectedChaptersData();
                this.updateUI();
            }

            deselectAllChapters() {
                this.selectedChapters = [];
                this.updateChapterButtonStates();
                this.loadSelectedChaptersData();
                this.updateUI();
            }

            updateChapterButtonStates() {
                document.querySelectorAll('.chapter-btn').forEach(btn => {
                    if (this.selectedChapters.includes(btn.dataset.chapter)) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            }

            async loadSelectedChaptersData() {
                if (this.selectedChapters.length === 0) {
                    this.questions = [];
                    this.score = 0;
                    this.totalQuestions = 0;
                    return;
                }

                try {
                    const userId = getUserId();
                    const { data, error } = await supabase
                        .from('study_data')
                        .select('*')
                        .eq('user_id', userId)
                        .eq('subject', this.currentSubject)
                        .in('chapter', this.selectedChapters);

                    if (error) throw error;

                    // ÈÅ∏Êäû„Åï„Çå„Åü„ÉÅ„É£„Éó„Çø„Éº„ÅÆÂïèÈ°å„ÇíÁµ±Âêà
                    this.questions = [];
                    this.score = 0;
                    this.totalQuestions = 0;

                    data.forEach(chapterData => {
                        if (chapterData.questions && chapterData.questions.length > 0) {
                            // ÂêÑÂïèÈ°å„Å´„ÉÅ„É£„Éó„Çø„ÉºÊÉÖÂ†±„ÇíËøΩÂä†
                            const questionsWithChapter = chapterData.questions.map(q => ({
                                ...q,
                                chapter: chapterData.chapter
                            }));
                            this.questions = [...this.questions, ...questionsWithChapter];
                        }
                        this.score += chapterData.score || 0;
                        this.totalQuestions += chapterData.total_questions || 0;
                    });

                } catch (error) {
                    console.error('„ÉÅ„É£„Éó„Çø„Éº„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                }
            }

            updateUI() {
                if (!this.currentSubject) {
                    document.getElementById('generate-section').classList.add('hidden');
                    document.getElementById('study-section').classList.add('hidden');
                    document.getElementById('management-section').classList.add('hidden');
                    document.getElementById('chapter-section').classList.add('hidden');
                    return;
                }
            
                document.getElementById('generate-section').classList.remove('hidden');
                document.getElementById('management-section').classList.remove('hidden');
            
                // ‰øÆÊ≠£: „ÉÅ„É£„Éó„Çø„Éº„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çå„Å∞Â≠¶Áøí„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
                if (this.selectedChapters.length > 0) {
                    document.getElementById('study-section').classList.remove('hidden');
                    document.getElementById('score').textContent = this.score;
                    document.getElementById('total').textContent = this.totalQuestions;
                    const percentage = this.totalQuestions > 0 ? Math.round((this.score / this.totalQuestions) * 100) : 0;
                    document.getElementById('percentage').textContent = percentage;
                    
                    const progress = this.totalQuestions > 0 ? (this.score / this.totalQuestions) * 100 : 0;
                    document.getElementById('progress-fill').style.width = `${progress}%`;
                } else {
                    document.getElementById('study-section').classList.add('hidden');
                }
            
                // ÂïèÈ°åÊï∞Ë°®Á§∫„ÇíÊõ¥Êñ∞ÔºàÈÅ∏Êäû„Åï„Çå„Åü„ÉÅ„É£„Éó„Çø„Éº„ÅÆÂïèÈ°åÊï∞„ÇíË°®Á§∫Ôºâ
                document.getElementById('question-count').textContent = this.questions.length;
                
                // „É¶„Éº„Ç∂„ÉºIDË°®Á§∫Êõ¥Êñ∞
                this.updateUserIdDisplay();
            }

            updateUserIdDisplay() {
                const currentUserId = getUserId();
                document.getElementById('current-user-id').textContent = currentUserId;
            }

            async generateQuestions() {
                const memo = document.getElementById('memo-input').value.trim();
                const chapterName = document.getElementById('chapter-name-input').value.trim();
                
                if (!memo) {
                    alert('ÊéàÊ•≠„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                if (!chapterName) {
                    alert('„ÉÅ„É£„Éó„Çø„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                // API„Ç≠„Éº„ÅÆÁ¢∫Ë™ç
                let apiKey = localStorage.getItem('anthropic_api_key');
                if (!apiKey) {
                    apiKey = prompt('Anthropic API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà‰ªäÂæå„ÅÆ„Åü„ÇÅ„Å´‰øùÂ≠ò„Åï„Çå„Åæ„ÅôÔºâ:');
                    if (!apiKey) {
                        alert('API„Ç≠„Éº„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
                        return;
                    }
                    localStorage.setItem('anthropic_api_key', apiKey);
                }

                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('generate-questions').disabled = true;

                try {
                    // Claude AI„ÅßÂïèÈ°åÁîüÊàê
                    const questions = await this.callClaudeAPI(memo, apiKey);
                    
                    await this.saveChapterData(chapterName, questions);
                    
                    // „ÉÅ„É£„Éó„Çø„Éº‰∏ÄË¶ß„ÇíÂÜçË™≠„ÅøËæº„Åø
                    await this.loadChaptersForSubject(this.currentSubject);
                    
                    document.getElementById('memo-input').value = '';
                    document.getElementById('chapter-name-input').value = '';
                    alert(`„ÉÅ„É£„Éó„Çø„Éº„Äå${chapterName}„Äç„ÅÆÂïèÈ°å„ÇíÁîüÊàê„Åó„Åæ„Åó„ÅüÔºÅ`);
                    
                } catch (error) {
                    console.error('API Error:', error);
                    
                    // API„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØ„Çµ„É≥„Éó„É´ÂïèÈ°å„Åß‰ª£Êõø
                    if (confirm('AI APIÊé•Á∂ö„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Çµ„É≥„Éó„É´ÂïèÈ°å„Åß‰ª£Êõø„Åó„Åæ„Åô„ÅãÔºü')) {
                        const sampleQuestions = this.generateSampleQuestions(memo);
                        await this.saveChapterData(chapterName, sampleQuestions);
                        await this.loadChaptersForSubject(this.currentSubject);
                        
                        document.getElementById('memo-input').value = '';
                        document.getElementById('chapter-name-input').value = '';
                        alert(`„ÉÅ„É£„Éó„Çø„Éº„Äå${chapterName}„Äç„ÅÆ„Çµ„É≥„Éó„É´ÂïèÈ°å„ÇíÁîüÊàê„Åó„Åæ„Åó„ÅüÔºÅ`);
                    }
                } finally {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('generate-questions').disabled = false;
                }
            }

            async saveChapterData(chapterName, questions) {
                try {
                    const userId = getUserId();
                    
                    // Êó¢Â≠ò„Éá„Éº„Çø„ÇíÂèñÂæó
                    const { data: existingData, error: fetchError } = await supabase
                        .from('study_data')
                        .select('questions, score, total_questions')
                        .eq('user_id', userId)
                        .eq('subject', this.currentSubject)
                        .eq('chapter', chapterName)
                        .single();
                    
                    let allQuestions = questions;
                    let currentScore = 0;
                    let currentTotal = 0;
                    
                    // Êó¢Â≠ò„Éá„Éº„Çø„Åå„ÅÇ„Çä„ÄÅquestions„ÅåÁ©∫„Åß„Å™„ÅÑÂ†¥Âêà„ÅØËøΩÂä†
                    if (existingData && existingData.questions && existingData.questions.length > 0) {
                        allQuestions = [...existingData.questions, ...questions];
                        currentScore = existingData.score || 0;
                        currentTotal = existingData.total_questions || 0;
                        console.log(`Êó¢Â≠ò„ÅÆ${existingData.questions.length}Âïè„Å´${questions.length}Âïè„ÇíËøΩÂä†`);
                    }
                    
                    const data = {
                        user_id: userId,
                        subject: this.currentSubject,
                        chapter: chapterName,
                        questions: allQuestions,
                        score: currentScore,
                        total_questions: currentTotal,
                        updated_at: new Date().toISOString()
                    };
            
                    const { error } = await supabase
                        .from('study_data')
                        .upsert(data, { onConflict: 'user_id,subject,chapter' });
            
                    if (error) throw error;
            
                    // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊõ¥Êñ∞
                    const isAddition = existingData && existingData.questions && existingData.questions.length > 0;
                    const message = isAddition 
                        ? `„ÉÅ„É£„Éó„Çø„Éº„Äå${chapterName}„Äç„Å´${questions.length}Âïè„ÇíËøΩÂä†„Åó„Åæ„Åó„ÅüÔºÅÔºàÂêàË®à: ${allQuestions.length}ÂïèÔºâ`
                        : `„ÉÅ„É£„Éó„Çø„Éº„Äå${chapterName}„Äç„Å´${questions.length}Âïè„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ`;
                    
                    return { isAddition, totalQuestions: allQuestions.length, message };
            
                } catch (error) {
                    console.error('„ÉÅ„É£„Éó„Çø„Éº„Éá„Éº„Çø‰øùÂ≠ò„Ç®„É©„Éº:', error);
                    alert('„Éá„Éº„Çø‰øùÂ≠ò„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                    throw error;
                }
            }

            generateSampleQuestions(memo) {
                // AI API„ÅÆ‰ª£„Çè„Çä„Å´„Çµ„É≥„Éó„É´ÂïèÈ°å„ÇíÁîüÊàêÔºàÂÆüË£ÖÊôÇ„ÅØAI API„Å´ÁΩÆ„ÅçÊèõ„ÅàÔºâ
                const sampleQuestions = [];
                const words = memo.split(/\s+/).filter(word => word.length > 2);
                
                for (let i = 0; i < Math.min(15, words.length); i++) {
                    const word = words[i];
                    
                    if (i % 2 === 0) {
                        // ÈÅ∏ÊäûËÇ¢ÂïèÈ°å
                        sampleQuestions.push({
                            type: 'multiple',
                            question: `„Äå${word}„Äç„Å´„Å§„ÅÑ„Å¶Ê≠£„Åó„ÅÑË™¨Êòé„ÅØ„Å©„Çå„Åß„Åô„ÅãÔºü`,
                            options: [
                                `${word}„ÅØÈáçË¶Å„Å™Ê¶ÇÂøµ„Åß„ÅÇ„Çã`,
                                `${word}„ÅØÈñ¢‰øÇ„ÅÆ„Å™„ÅÑË¶ÅÁ¥†„Åß„ÅÇ„Çã`,
                                `${word}„ÅØÂè§„ÅÑÁêÜË´ñ„Åß„ÅÇ„Çã`,
                                `${word}„ÅØÈñìÈÅï„Å£„ÅüËÄÉ„ÅàÊñπ„Åß„ÅÇ„Çã`
                            ],
                            correctAnswer: 0
                        });
                    } else {
                        // Á©¥Âüã„ÇÅÂïèÈ°å
                        sampleQuestions.push({
                            type: 'fillblank',
                            question: `ÊéàÊ•≠„ÅßÂ≠¶„Çì„Å†ÈáçË¶Å„Å™Ê¶ÇÂøµ„Äå____„Äç„Å´„Å§„ÅÑ„Å¶Ë™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                            correctAnswer: word
                        });
                    }
                }
                
                return sampleQuestions;
            }

            async callClaudeAPI(memo, apiKey) {
                const apiUrl = 'https://api.anthropic.com/v1/messages';
                
                const prompt = `‰ª•‰∏ã„ÅÆÊéàÊ•≠„É°„É¢„Åã„Çâ„ÄÅ15Âïè„ÅÆ1Âïè1Á≠îÂïèÈ°å„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
ÈÅ∏ÊäûËÇ¢ÂïèÈ°å„Å®Á©¥Âüã„ÇÅÂïèÈ°å„ÇíÂçä„ÄÖÁ®ãÂ∫¶„ÅßÊ∑∑Âú®„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
ÈÅ∏ÊäûËÇ¢ÂïèÈ°å„ÅØ4Êäû„Åß„ÄÅ1„Å§„ÅÆÊ≠£Ëß£„Å®3„Å§„ÅÆÈñìÈÅï„Å£„ÅüÈÅ∏ÊäûËÇ¢„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
Á©¥Âüã„ÇÅÂïèÈ°å„ÅØÈáçË¶Å„Å™„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÁ≠î„Åà„Å®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

ÊéàÊ•≠„É°„É¢:
${memo}

JSON„ÅÆ„Åø„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàË™¨ÊòéÊñá„ÅØ‰∏çË¶ÅÔºâ:
[
  {
    "type": "multiple",
    "question": "ÂïèÈ°åÊñá",
    "options": ["ÈÅ∏ÊäûËÇ¢1", "ÈÅ∏ÊäûËÇ¢2", "ÈÅ∏ÊäûËÇ¢3", "ÈÅ∏ÊäûËÇ¢4"],
    "correctAnswer": 0
  },
  {
    "type": "fillblank", 
    "question": "____„Å´ÂÖ•„ÇãË™ûÂè•„ÅØ‰Ωï„Åß„Åô„ÅãÔºü",
    "correctAnswer": "Ê≠£Ëß£„ÅÆË™ûÂè•"
  }
]`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-sonnet-20240229',
                        max_tokens: 4000,
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorData}`);
                }

                const data = await response.json();
                const content = data.content[0].text;
                
                // JSON„ÅÆÊäΩÂá∫
                let jsonStr = content;
                const jsonMatch = content.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
                if (jsonMatch) {
                    jsonStr = jsonMatch[1];
                } else {
                    const arrayMatch = content.match(/\[[\s\S]*\]/);
                    if (arrayMatch) {
                        jsonStr = arrayMatch[0];
                    }
                }
                
                try {
                    return JSON.parse(jsonStr);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.error('Response content:', content);
                    throw new Error('Claude API„ÅÆÂøúÁ≠î„ÇíJSON„Å®„Åó„Å¶Ëß£Êûê„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }
            }

            generatePrompt() {
                const memo = document.getElementById('memo-input').value.trim();
                const chapterName = document.getElementById('chapter-name-input').value.trim();
                
                if (!memo) {
                    alert('ÊéàÊ•≠„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                if (!chapterName) {
                    alert('„ÉÅ„É£„Éó„Çø„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                const prompt = `‰ª•‰∏ã„ÅÆÊéàÊ•≠„É°„É¢„Åã„Çâ„ÄÅ15Âïè„ÅÆ1Âïè1Á≠îÂïèÈ°å„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
ÈÅ∏ÊäûËÇ¢ÂïèÈ°å„Å®Á©¥Âüã„ÇÅÂïèÈ°å„ÇíÂçä„ÄÖÁ®ãÂ∫¶„ÅßÊ∑∑Âú®„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
ÈÅ∏ÊäûËÇ¢ÂïèÈ°å„ÅØ4Êäû„Åß„ÄÅ1„Å§„ÅÆÊ≠£Ëß£„Å®3„Å§„ÅÆÈñìÈÅï„Å£„ÅüÈÅ∏ÊäûËÇ¢„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
Á©¥Âüã„ÇÅÂïèÈ°å„ÅØÈáçË¶Å„Å™„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÁ≠î„Åà„Å®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

ÂØæË±°„ÉÅ„É£„Éó„Çø„Éº: ${chapterName}
ÊéàÊ•≠„É°„É¢:
${memo}

ÂøÖ„Åö‰ª•‰∏ã„ÅÆJSONÂΩ¢Âºè„ÅÆ„Åø„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàË™¨ÊòéÊñá„ÇÑËøΩÂä†„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÅØ‰∏ÄÂàá‰∏çË¶ÅÔºâ:
[
  {
    "type": "multiple",
    "question": "ÂïèÈ°åÊñá",
    "options": ["ÈÅ∏ÊäûËÇ¢1", "ÈÅ∏ÊäûËÇ¢2", "ÈÅ∏ÊäûËÇ¢3", "ÈÅ∏ÊäûËÇ¢4"],
    "correctAnswer": 0
  },
  {
    "type": "fillblank", 
    "question": "____„Å´ÂÖ•„ÇãË™ûÂè•„ÅØ‰Ωï„Åß„Åô„ÅãÔºü",
    "correctAnswer": "Ê≠£Ëß£„ÅÆË™ûÂè•"
  }
]`;

                document.getElementById('prompt-text').value = prompt;
                document.getElementById('prompt-display').classList.remove('hidden');
                document.getElementById('import-area').classList.add('hidden');
            }

            copyPrompt() {
                const promptText = document.getElementById('prompt-text');
                promptText.select();
                document.execCommand('copy');
                alert('„Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅClaude AI„Å´Ë≤º„Çä‰ªò„Åë„Å¶ÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }

            showImportArea() {
                document.getElementById('import-area').classList.remove('hidden');
                document.getElementById('prompt-display').classList.add('hidden');
            }

            processImport() {
                const importText = document.getElementById('import-text').value.trim();
                const chapterName = document.getElementById('chapter-name-input').value.trim();
                
                if (!importText) {
                    alert('Claude AI„ÅÆÂõûÁ≠î„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                if (!chapterName) {
                    alert('„ÉÅ„É£„Éó„Çø„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                try {
                    // JSON„ÅÆÊäΩÂá∫„ÇíË©¶Ë°å
                    let jsonStr = importText;
                    
                    // „Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ„ÅßÂõ≤„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
                    const jsonMatch = importText.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
                    if (jsonMatch) {
                        jsonStr = jsonMatch[1];
                    } else {
                        // [ „ÅßÂßã„Åæ„Çä ] „ÅßÁµÇ„Çè„ÇãJSON„ÇíÊäΩÂá∫
                        const arrayMatch = importText.match(/\[[\s\S]*\]/);
                        if (arrayMatch) {
                            jsonStr = arrayMatch[0];
                        }
                    }
                    
                    const questions = JSON.parse(jsonStr);
                    
                    // ÂïèÈ°åÂΩ¢Âºè„ÅÆÊ§úË®º
                    if (!Array.isArray(questions)) {
                        throw new Error('ÂïèÈ°å„ÅØÈÖçÂàóÂΩ¢Âºè„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô');
                    }
                    
                    for (const q of questions) {
                        if (!q.type || !q.question) {
                            throw new Error('ÂïèÈ°å„Å´type, question„ÅåÂøÖË¶Å„Åß„Åô');
                        }
                        if (q.type === 'multiple' && (!q.options || !q.hasOwnProperty('correctAnswer'))) {
                            throw new Error('ÈÅ∏ÊäûËÇ¢ÂïèÈ°å„Å´„ÅØoptions, correctAnswer„ÅåÂøÖË¶Å„Åß„Åô');
                        }
                        if (q.type === 'fillblank' && !q.correctAnswer) {
                            throw new Error('Á©¥Âüã„ÇÅÂïèÈ°å„Å´„ÅØcorrectAnswer„ÅåÂøÖË¶Å„Åß„Åô');
                        }
                    }
                    // „ÉÅ„É£„Éó„Çø„Éº„Éá„Éº„Çø„Å®„Åó„Å¶‰øùÂ≠ò
                    this.saveChapterData(chapterName, questions).then((result) => {
                        // „ÉÅ„É£„Éó„Çø„Éº‰∏ÄË¶ß„ÇíÂÜçË™≠„ÅøËæº„Åø
                        this.loadChaptersForSubject(this.currentSubject);
                        
                        // UI „É™„Çª„ÉÉ„Éà
                        document.getElementById('memo-input').value = '';
                        document.getElementById('chapter-name-input').value = '';
                        document.getElementById('import-text').value = '';
                        document.getElementById('import-area').classList.add('hidden');
                        document.getElementById('prompt-display').classList.add('hidden');
                        
                        alert(result.message);
                    });
                    
                } catch (error) {
                    alert(`„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº: ${error.message}\n\nJSONÂΩ¢Âºè„ÅåÊ≠£„Åó„ÅÑ„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                    console.error('Import error:', error);
                    console.error('Import text:', importText);
                }
            }

            startQuiz() {
                if (this.selectedChapters.length === 0) {
                    alert('Â≠¶Áøí„Åô„Çã„ÉÅ„É£„Éó„Çø„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                if (this.questions.length === 0) {
                    alert('ÈÅ∏Êäû„Åï„Çå„Åü„ÉÅ„É£„Éó„Çø„Éº„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                    return;
                }

                this.currentQuestionIndex = 0;
                this.isAnswered = false;
                
                document.getElementById('quiz-section').style.display = 'block';
                this.showQuestion();
            }

            showQuestion() {
                if (this.currentQuestionIndex >= this.questions.length) {
                    this.endQuiz();
                    return;
                }

                const question = this.questions[this.currentQuestionIndex];
                const chapterInfo = question.chapter ? ` („ÉÅ„É£„Éó„Çø„Éº ${question.chapter})` : '';
                document.getElementById('question-text').textContent = 
                    `ÂïèÈ°å ${this.currentQuestionIndex + 1}/${this.questions.length}${chapterInfo}: ${question.question}`;

                const optionsContainer = document.getElementById('options-container');
                const fillBlankInput = document.getElementById('fill-blank-input');
                const submitBtn = document.getElementById('submit-answer');
                const nextBtn = document.getElementById('next-question');

                // „É™„Çª„ÉÉ„Éà
                optionsContainer.innerHTML = '';
                fillBlankInput.classList.add('hidden');
                submitBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
                this.isAnswered = false;

                if (question.type === 'multiple') {
                    // ÈÅ∏ÊäûËÇ¢ÂïèÈ°å
                    question.options.forEach((option, index) => {
                        const btn = document.createElement('button');
                        btn.className = 'option-btn';
                        btn.textContent = option;
                        btn.addEventListener('click', () => this.selectOption(index, btn));
                        optionsContainer.appendChild(btn);
                    });
                } else if (question.type === 'fillblank') {
                    // Á©¥Âüã„ÇÅÂïèÈ°å
                    fillBlankInput.classList.remove('hidden');
                    fillBlankInput.value = '';
                    submitBtn.classList.remove('hidden');
                }
            }

            async selectOption(index, btnElement) {
                if (this.isAnswered) return;

                const question = this.questions[this.currentQuestionIndex];
                const correct = index === question.correctAnswer;

                // ÂÖ®„Å¶„ÅÆÈÅ∏ÊäûËÇ¢„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.style.pointerEvents = 'none';
                });

                // Ê≠£Ëß£„Éª‰∏çÊ≠£Ëß£„ÅÆË°®Á§∫
                if (correct) {
                    btnElement.classList.add('correct');
                    this.score++;
                } else {
                    btnElement.classList.add('incorrect');
                    // Ê≠£Ëß£„ÇÇË°®Á§∫
                    document.querySelectorAll('.option-btn')[question.correctAnswer].classList.add('correct');
                }

                this.totalQuestions++;
                this.isAnswered = true;
                
                // „ÉÅ„É£„Éó„Çø„ÉºÂà•„Çπ„Ç≥„Ç¢„ÇíÊõ¥Êñ∞
                await this.updateChapterScore(question.chapter, correct);
                
                this.updateUI();

                document.getElementById('next-question').classList.remove('hidden');
            }

            async submitAnswer() {
                if (this.isAnswered) return;

                const userAnswer = document.getElementById('fill-blank-input').value.trim();
                const question = this.questions[this.currentQuestionIndex];

                if (!userAnswer) {
                    alert('Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                const correct = userAnswer.toLowerCase() === question.correctAnswer.toLowerCase();

                if (correct) {
                    alert('Ê≠£Ëß£ÔºÅ');
                    this.score++;
                } else {
                    alert(`‰∏çÊ≠£Ëß£„ÄÇÊ≠£Ëß£„ÅØ„Äå${question.correctAnswer}„Äç„Åß„Åô„ÄÇ`);
                }

                this.totalQuestions++;
                this.isAnswered = true;
                
                // „ÉÅ„É£„Éó„Çø„ÉºÂà•„Çπ„Ç≥„Ç¢„ÇíÊõ¥Êñ∞
                await this.updateChapterScore(question.chapter, correct);
                
                this.updateUI();

                document.getElementById('submit-answer').classList.add('hidden');
                document.getElementById('next-question').classList.remove('hidden');
            }

            async updateChapterScore(chapter, isCorrect) {
                try {
                    const userId = getUserId();
                    
                    // Ë©≤ÂΩì„ÉÅ„É£„Éó„Çø„Éº„ÅÆÁèæÂú®„ÅÆ„Çπ„Ç≥„Ç¢„ÇíÂèñÂæó
                    const { data, error: fetchError } = await supabase
                        .from('study_data')
                        .select('score, total_questions')
                        .eq('user_id', userId)
                        .eq('subject', this.currentSubject)
                        .eq('chapter', chapter)
                        .single();

                    if (fetchError) throw fetchError;

                    const newScore = (data.score || 0) + (isCorrect ? 1 : 0);
                    const newTotal = (data.total_questions || 0) + 1;

                    // „Çπ„Ç≥„Ç¢„ÇíÊõ¥Êñ∞
                    const { error: updateError } = await supabase
                        .from('study_data')
                        .update({
                            score: newScore,
                            total_questions: newTotal,
                            updated_at: new Date().toISOString()
                        })
                        .eq('user_id', userId)
                        .eq('subject', this.currentSubject)
                        .eq('chapter', chapter);

                    if (updateError) throw updateError;

                } catch (error) {
                    console.error('„Çπ„Ç≥„Ç¢Êõ¥Êñ∞„Ç®„É©„Éº:', error);
                }
            }

            nextQuestion() {
                this.currentQuestionIndex++;
                this.showQuestion();
            }

            endQuiz() {
                document.getElementById('quiz-section').style.display = 'none';
                const percentage = Math.round((this.score / this.totalQuestions) * 100);
                alert(`Â≠¶ÁøíÂÆå‰∫ÜÔºÅÊ≠£Ëß£Áéá: ${percentage}%`);
            }

            resetProgress() {
                if (this.selectedChapters.length === 0) {
                    alert('„ÉÅ„É£„Éó„Çø„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                if (confirm(`ÈÅ∏Êäû„Åï„Çå„Åü„ÉÅ„É£„Éó„Çø„Éº„ÅÆÈÄ≤Êçó„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü`)) {
                    this.resetSelectedChaptersProgress();
                }
            }

            async resetSelectedChaptersProgress() {
                try {
                    const userId = getUserId();
                    
                    for (const chapter of this.selectedChapters) {
                        const { error } = await supabase
                            .from('study_data')
                            .update({
                                score: 0,
                                total_questions: 0,
                                updated_at: new Date().toISOString()
                            })
                            .eq('user_id', userId)
                            .eq('subject', this.currentSubject)
                            .eq('chapter', chapter);

                        if (error) throw error;
                    }

                    // „Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
                    await this.loadSelectedChaptersData();
                    await this.loadChaptersForSubject(this.currentSubject);
                    this.updateUI();

                    alert('ÈÅ∏Êäû„Åï„Çå„Åü„ÉÅ„É£„Éó„Çø„Éº„ÅÆÈÄ≤Êçó„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ');

                } catch (error) {
                    console.error('ÈÄ≤Êçó„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº:', error);
                    alert('ÈÄ≤Êçó„É™„Çª„ÉÉ„Éà„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }

            showQuestionList() {
                const listElement = document.getElementById('question-list');
                
                if (listElement.classList.contains('hidden')) {
                    listElement.innerHTML = '';
                    this.questions.forEach((q, index) => {
                        const item = document.createElement('div');
                        item.className = 'question-item';
                        const chapterInfo = q.chapter ? ` [„ÉÅ„É£„Éó„Çø„Éº ${q.chapter}]` : '';
                        item.innerHTML = `
                            <strong>Q${index + 1}${chapterInfo}:</strong> ${q.question}
                            <button class="delete-btn" onclick="app.deleteQuestion(${index})">ÂâäÈô§</button>
                        `;
                        listElement.appendChild(item);
                    });
                    listElement.classList.remove('hidden');
                } else {
                    listElement.classList.add('hidden');
                }
            }

            deleteQuestion(index) {
                if (confirm('„Åì„ÅÆÂïèÈ°å„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                    this.questions.splice(index, 1);
                    this.updateUI();
                    this.showQuestionList();
                }
            }

            clearSubjectData() {
                if (confirm(`${this.currentSubject}„ÅÆ„Åô„Åπ„Å¶„ÅÆ„ÉÅ„É£„Éó„Çø„Éº„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                    this.clearAllChaptersData();
                }
            }

            async clearAllChaptersData() {
                try {
                    const userId = getUserId();
                    const { error } = await supabase
                        .from('study_data')
                        .delete()
                        .eq('user_id', userId)
                        .eq('subject', this.currentSubject);

                    if (error) throw error;

                    // UIÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                    this.selectedChapters = [];
                    this.allChapters[this.currentSubject] = [];
                    this.questions = [];
                    this.score = 0;
                    this.totalQuestions = 0;

                    this.updateUI();
                    this.displayChapterSelector();
                    document.getElementById('question-list').classList.add('hidden');

                    alert(`${this.currentSubject}„ÅÆ„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ`);

                } catch (error) {
                    console.error('„Éá„Éº„ÇøÂâäÈô§„Ç®„É©„Éº:', error);
                    alert('„Éá„Éº„ÇøÂâäÈô§„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }

            manageAPIKey() {
                const currentKey = localStorage.getItem('anthropic_api_key');
                let message = 'Anthropic API„Ç≠„ÉºÁÆ°ÁêÜ\n\n';
                
                if (currentKey) {
                    message += `ÁèæÂú®„ÅÆ„Ç≠„Éº: ${currentKey.substring(0, 10)}...\n\n`;
                    message += '1. Êñ∞„Åó„ÅÑ„Ç≠„Éº„ÇíÂÖ•Âäõ\n2. „Ç≠„Éº„ÇíÂâäÈô§\n3. „Ç≠„É£„É≥„Çª„É´';
                    
                    const choice = prompt(message + '\n\nÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ (1/2/3):');
                    
                    if (choice === '1') {
                        const newKey = prompt('Êñ∞„Åó„ÅÑAnthropic API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
                        if (newKey) {
                            localStorage.setItem('anthropic_api_key', newKey);
                            alert('API„Ç≠„Éº„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇ');
                        }
                    } else if (choice === '2') {
                        if (confirm('API„Ç≠„Éº„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                            localStorage.removeItem('anthropic_api_key');
                            alert('API„Ç≠„Éº„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ');
                        }
                    }
                } else {
                    const newKey = prompt('Anthropic API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
                    if (newKey) {
                        localStorage.setItem('anthropic_api_key', newKey);
                        alert('API„Ç≠„Éº„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
                    }
                }
            }

            showDebugInfo() {
                const apiKey = localStorage.getItem('anthropic_api_key');
                
                let debug = '=== „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†± ===\n\n';
                debug += `ÁèæÂú®„ÅÆÁßëÁõÆ: ${this.currentSubject || '„Å™„Åó'}\n`;
                debug += `ÈÅ∏Êäû„Åï„Çå„Åü„ÉÅ„É£„Éó„Çø„Éº: ${this.selectedChapters.join(', ') || '„Å™„Åó'}\n`;
                debug += `API„Ç≠„Éº: ${apiKey ? `Ë®≠ÂÆöÊ∏à„Åø (${apiKey.substring(0, 10)}...)` : 'Êú™Ë®≠ÂÆö'}\n`;
                debug += `ÂïèÈ°åÊï∞: ${this.questions.length}\n`;
                debug += `Ê≠£Ëß£/Á∑èÂïèÈ°å: ${this.score}/${this.totalQuestions}\n`;
                debug += `ÁîªÈù¢ÂπÖ: ${window.innerWidth}px\n`;
                debug += `„É¶„Éº„Ç∂„Éº„Ç®„Éº„Ç∏„Çß„É≥„Éà: ${navigator.userAgent.includes('Mobile') ? '„É¢„Éê„Ç§„É´' : '„Éá„Çπ„ÇØ„Éà„ÉÉ„Éó'}\n\n`;
                
                debug += '=== UIË°®Á§∫Áä∂ÊÖã ===\n';
                debug += `generate-section: ${document.getElementById('generate-section').classList.contains('hidden') ? 'ÈùûË°®Á§∫' : 'Ë°®Á§∫'}\n`;
                debug += `study-section: ${document.getElementById('study-section').classList.contains('hidden') ? 'ÈùûË°®Á§∫' : 'Ë°®Á§∫'}\n`;
                debug += `chapter-section: ${document.getElementById('chapter-section').classList.contains('hidden') ? 'ÈùûË°®Á§∫' : 'Ë°®Á§∫'}\n`;
                debug += `management-section: ${document.getElementById('management-section').classList.contains('hidden') ? 'ÈùûË°®Á§∫' : 'Ë°®Á§∫'}\n\n`;
                
                debug += '=== „ÉÅ„É£„Éó„Çø„ÉºÊÉÖÂ†± ===\n';
                if (this.currentSubject && this.allChapters[this.currentSubject]) {
                    this.allChapters[this.currentSubject].forEach(chapter => {
                        debug += `${chapter.chapter}: ${chapter.questions ? chapter.questions.length : 0}Âïè\n`;
                    });
                }
                
                alert(debug);
            }

            // SupabaseÈñ¢ÈÄ£„É°„ÇΩ„ÉÉ„Éâ

            async saveToCloud() {
                try {
                    const button = document.getElementById('save-to-cloud');
                    button.disabled = true;
                    button.textContent = '‰øùÂ≠ò‰∏≠...';

                    const userId = getUserId();
                    
                    // Êó¢Â≠ò„ÅÆSupabase„Éá„Éº„Çø„ÅØÊó¢„Å´„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß„ÄÅ
                    // LocalStorage„ÅÆ„É¨„Ç¨„Ç∑„Éº„Éá„Éº„Çø„Åå„ÅÇ„Çå„Å∞ÁßªË°å
                    let migratedCount = 0;
                    
                    for (const subject of ['decision', 'philosophy', 'communication']) {
                        const key = `study_app_${subject}`;
                        const localData = localStorage.getItem(key);
                        
                        if (localData) {
                            const parsedData = JSON.parse(localData);
                            
                            if (parsedData.questions && parsedData.questions.length > 0) {
                                // „É¨„Ç¨„Ç∑„Éº„Éá„Éº„Çø„ÇíÊñ∞„Åó„ÅÑÂΩ¢Âºè„Å´Â§âÊèõ
                                const chapterName = `ÁßªË°å„Éá„Éº„Çø - ${new Date().toLocaleDateString()}`;
                                const data = {
                                    user_id: userId,
                                    subject: subject,
                                    chapter: chapterName,
                                    questions: parsedData.questions,
                                    score: parsedData.score || 0,
                                    total_questions: parsedData.totalQuestions || 0,
                                    updated_at: new Date().toISOString()
                                };

                                const { error } = await supabase
                                    .from('study_data')
                                    .upsert(data, { onConflict: 'user_id,subject,chapter' });

                                if (error) throw error;
                                migratedCount++;
                                
                                // ÁßªË°åÂæå„ÅØÂè§„ÅÑ„Éá„Éº„Çø„ÇíÂâäÈô§
                                localStorage.removeItem(key);
                            }
                        }
                    }

                    if (migratedCount > 0) {
                        alert(`„Éá„Éº„ÇøÁßªË°åÂÆå‰∫ÜÔºÅ${migratedCount}ÁßëÁõÆ„ÅÆ„É¨„Ç¨„Ç∑„Éº„Éá„Éº„Çø„Çí„ÇØ„É©„Ç¶„Éâ„Å´ÁßªË°å„Åó„Åæ„Åó„Åü„ÄÇ`);
                    } else {
                        alert('„Éá„Éº„Çø„ÅØÊó¢„Å´„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
                    }

                } catch (error) {
                    console.error('‰øùÂ≠ò„Ç®„É©„Éº:', error);
                    alert('‰øùÂ≠ò„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                } finally {
                    const button = document.getElementById('save-to-cloud');
                    button.disabled = false;
                    button.textContent = 'üì§ „ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò';
                }
            }

            async loadFromCloud() {
                try {
                    const button = document.getElementById('load-from-cloud');
                    button.disabled = true;
                    button.textContent = 'Ë™≠„ÅøËæº„Åø‰∏≠...';

                    const userId = getUserId();
                    const { data, error } = await supabase
                        .from('study_data')
                        .select('*')
                        .eq('user_id', userId);

                    if (error) throw error;

                    if (data.length === 0) {
                        alert('„ÇØ„É©„Ç¶„Éâ„Å´„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\n\nÂÖà„Å´‰ªñ„ÅÆ„Éá„Éê„Ç§„Çπ„ÅßÂïèÈ°å„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        return;
                    }

                    // ÁèæÂú®„ÅÆÁßëÁõÆ„ÅÆ„ÉÅ„É£„Éó„Çø„Éº„ÇíÂÜçË™≠„ÅøËæº„Åø
                    if (this.currentSubject) {
                        await this.loadChaptersForSubject(this.currentSubject);
                        this.updateUI();
                    }

                    alert(`„ÇØ„É©„Ç¶„ÉâË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÔºÅ${data.length}‰ª∂„ÅÆ„ÉÅ„É£„Éó„Çø„Éº„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ\n\nÁßëÁõÆ„Å®„ÉÅ„É£„Éó„Çø„Éº„ÇíÈÅ∏Êäû„Åó„Å¶Â≠¶Áøí„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);

                } catch (error) {
                    console.error('Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    alert('Ë™≠„ÅøËæº„Åø„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                } finally {
                    const button = document.getElementById('load-from-cloud');
                    button.disabled = false;
                    button.textContent = 'üì• „ÇØ„É©„Ç¶„Éâ„Åã„ÇâË™≠„ÅøËæº„Åø';
                }
            }

            exportData() {
                alert('Êñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„Åß„ÅØ„ÄÅ„Éá„Éº„Çø„ÅØËá™ÂãïÁöÑ„Å´„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ\n„Äåüì• „ÇØ„É©„Ç¶„Éâ„Åã„ÇâË™≠„ÅøËæº„Åø„Äç„Çí‰ΩøÁî®„Åó„Å¶‰ªñ„ÅÆ„Éá„Éê„Ç§„Çπ„Åß„Éá„Éº„Çø„ÇíÂêåÊúü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }

            showDataImportArea() {
                alert('Êñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„Åß„ÅØ„ÄÅ„Äåüì• „ÇØ„É©„Ç¶„Éâ„Åã„ÇâË™≠„ÅøËæº„Åø„Äç„Çí‰ΩøÁî®„Åó„Å¶„Éá„Éº„Çø„ÇíÂêåÊúü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }

            processDataImport() {
                alert('Êñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„Åß„ÅØ„ÄÅ„Äåüì• „ÇØ„É©„Ç¶„Éâ„Åã„ÇâË™≠„ÅøËæº„Åø„Äç„Çí‰ΩøÁî®„Åó„Å¶„Éá„Éº„Çø„ÇíÂêåÊúü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }

            setUserId() {
                const newUserId = document.getElementById('user-id-input').value.trim();
                
                if (!newUserId) {
                    alert('„É¶„Éº„Ç∂„ÉºID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                // IDÂΩ¢Âºè„ÅÆÁ∞°Âçò„Å™Ê§úË®º
                if (newUserId.length < 3) {
                    alert('„É¶„Éº„Ç∂„ÉºID„ÅØ3ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                if (!/^[a-zA-Z0-9_-]+$/.test(newUserId)) {
                    alert('„É¶„Éº„Ç∂„ÉºID„ÅØËã±Êï∞Â≠ó„ÄÅ„Éè„Ç§„Éï„É≥„ÄÅ„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„ÅÆ„Åø‰ΩøÁî®„Åß„Åç„Åæ„Åô„ÄÇ');
                    return;
                }

                const currentUserId = localStorage.getItem('study_app_user_id');
                
                if (currentUserId && currentUserId !== newUserId) {
                    if (!confirm(`ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºID„Äå${currentUserId}„Äç„Çí„Äå${newUserId}„Äç„Å´Â§âÊõ¥„Åó„Åæ„Åô„ÅãÔºü\n\nÊ≥®ÊÑè: Â§âÊõ¥Âæå„ÅØ„ÇØ„É©„Ç¶„ÉâÂêåÊúü„Åß„Éá„Éº„Çø„ÇíÂÜçÂèñÂæó„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ`)) {
                        return;
                    }
                }

                // „É¶„Éº„Ç∂„ÉºIDË®≠ÂÆö
                localStorage.setItem('study_app_user_id', newUserId);
                this.updateUserIdDisplay();
                document.getElementById('user-id-input').value = '';

                alert(`„É¶„Éº„Ç∂„ÉºID„Çí„Äå${newUserId}„Äç„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„ÅüÔºÅ\n\n‰ªñ„ÅÆ„Éá„Éê„Ç§„Çπ„Åß„ÇÇÂêå„ÅòID„ÇíË®≠ÂÆö„Åó„Å¶„ÇØ„É©„Ç¶„ÉâÂêåÊúü„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
            }
        }

        // „Ç¢„Éó„É™ÂàùÊúüÂåñ
        const app = new StudyApp();
    </script>
</body>
</html>
