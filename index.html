<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1問1答学習アプリ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .app-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .app-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .subject-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .subject-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: #f8f9fa;
            color: #333;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            min-height: 60px;
            word-wrap: break-word;
        }
        
        .subject-btn:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .subject-btn.active {
            background: #667eea;
            color: white;
            border-color: #5a67d8;
        }
        
        /* モバイル対応 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .app-header h1 {
                font-size: 2em;
            }
            
            .subject-selector {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .subject-btn {
                font-size: 18px;
                padding: 20px;
                min-height: 70px;
            }
            
            .generate-btn, .action-btn {
                font-size: 14px;
                padding: 10px 15px;
                margin: 5px 2px;
                display: block;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .memo-input {
                font-size: 16px;
            }
            
            .question-text {
                font-size: 16px;
            }
            
            .option-btn {
                font-size: 14px;
                padding: 12px;
            }
            
            .card {
                padding: 20px;
                margin-bottom: 15px;
            }
        }
        
        .input-section {
            margin: 20px 0;
        }
        
        .input-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
        }
        
        .memo-input {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }
        
        .memo-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .generate-btn, .action-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background 0.3s ease;
        }
        
        .generate-btn:hover, .action-btn:hover {
            background: #5a67d8;
        }
        
        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .quiz-section {
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s ease;
        }
        
        .question-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }
        
        .question-text {
            font-size: 18px;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .options {
            display: grid;
            gap: 10px;
        }
        
        .option-btn {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option-btn:hover {
            border-color: #667eea;
        }
        
        .option-btn.correct {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .option-btn.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .fill-blank-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .score-display {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            color: #555;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            color: #667eea;
            font-style: italic;
        }
        
        .management-section {
            margin-top: 30px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }
        
        .question-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .question-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            float: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header">
            <h1>📚 1問1答学習アプリ</h1>
            <p>効率的なスキマ時間学習で目標達成！</p>
        </div>

        <div class="card">
            <h2>科目選択</h2>
            <div class="subject-selector">
                <button class="subject-btn" data-subject="decision">意思決定の理論</button>
                <button class="subject-btn" data-subject="philosophy">公共哲学</button>
                <button class="subject-btn" data-subject="communication">多言語ITコミュニケーション</button>
            </div>

            <!-- 問題生成セクション -->
            <div id="generate-section" class="hidden">
                <div class="input-section">
                    <label for="memo-input">授業メモを貼り付けて問題を生成：</label>
                    <textarea id="memo-input" class="memo-input" placeholder="授業メモをここに貼り付けてください..."></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="generate-questions" class="generate-btn">AIで問題生成 (実験的)</button>
                    <button id="generate-prompt" class="generate-btn" style="background: #28a745;">Claude用プロンプト生成</button>
                    <button id="import-questions" class="generate-btn" style="background: #fd7e14;">生成済み問題インポート</button>
                </div>
                
                <div id="loading" class="loading hidden">問題を生成中...</div>
                
                <!-- プロンプト表示エリア -->
                <div id="prompt-display" class="hidden" style="margin-top: 20px;">
                    <label>以下をClaude AIにコピペしてください：</label>
                    <textarea id="prompt-text" class="memo-input" readonly style="background: #f8f9fa; height: 150px;"></textarea>
                    <button id="copy-prompt" class="action-btn">プロンプトをコピー</button>
                </div>
                
                <!-- インポートエリア -->
                <div id="import-area" class="hidden" style="margin-top: 20px;">
                    <label>Claude AIの回答をここに貼り付けてください：</label>
                    <textarea id="import-text" class="memo-input" placeholder="Claude AIが生成したJSON形式の問題をここに貼り付けてください..."></textarea>
                    <button id="process-import" class="action-btn">問題をインポート</button>
                </div>
            </div>

            <!-- 学習セクション -->
            <div id="study-section" class="hidden">
                <div class="score-display">
                    正解率: <span id="score">0</span>/<span id="total">0</span> (<span id="percentage">0</span>%)
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <button id="start-quiz" class="action-btn">学習開始 (15問)</button>
                <button id="reset-progress" class="action-btn">進捗リセット</button>
            </div>

            <!-- クイズセクション -->
            <div id="quiz-section" class="quiz-section">
                <div class="question-card">
                    <div class="question-text" id="question-text"></div>
                    <div id="options-container"></div>
                    <input type="text" id="fill-blank-input" class="fill-blank-input hidden" placeholder="答えを入力してください">
                    <button id="submit-answer" class="action-btn hidden">回答</button>
                    <button id="next-question" class="action-btn hidden">次の問題</button>
                </div>
            </div>

            <!-- 問題管理セクション -->
            <div id="management-section" class="management-section hidden">
                <h3>問題管理</h3>
                <p>保存済み問題数: <span id="question-count">0</span></p>
                <button id="show-questions" class="action-btn">問題一覧表示</button>
                <button id="clear-subject-data" class="action-btn" style="background: #dc3545;">科目データ削除</button>
                <button id="manage-api-key" class="action-btn" style="background: #6c757d;">APIキー管理</button>
                <button id="debug-info" class="action-btn" style="background: #17a2b8;">デバッグ情報</button>
                
                <!-- データ移行セクション -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                    <h4>📱 デバイス間データ移行</h4>
                    <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">ユーザーID:</label>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="user-id-input" placeholder="共有用のユーザーIDを入力" style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <button id="set-user-id" class="action-btn" style="background: #6f42c1;">ID設定</button>
                        </div>
                        <small style="color: #666; margin-top: 5px; display: block;">
                            現在のID: <span id="current-user-id">未設定</span>
                        </small>
                    </div>
                    
                    <button id="export-data" class="action-btn" style="background: #28a745;">📋 データエクスポート</button>
                    <button id="import-data" class="action-btn" style="background: #fd7e14;">📋 データインポート</button>
                    <button id="save-to-cloud" class="action-btn" style="background: #007bff;">📤 クラウドに保存</button>
                    <button id="load-from-cloud" class="action-btn" style="background: #17a2b8;">📥 クラウドから読み込み</button>
                </div>
                
                <!-- インポートエリア -->
                <div id="data-import-area" class="hidden" style="margin-top: 15px;">
                    <label>エクスポートしたデータを貼り付けてください：</label>
                    <textarea id="import-data-text" class="memo-input" style="height: 100px;" placeholder="エクスポートしたデータをここに貼り付けてください..."></textarea>
                    <button id="process-data-import" class="action-btn">データをインポート</button>
                </div>
                <div id="question-list" class="question-list hidden"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase設定
        const SUPABASE_URL = 'https://zayngisercbordbjzats.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpheW5naXNlcmNib3JkYmp6YXRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMTY4NzEsImV4cCI6MjA3MDg5Mjg3MX0.kRO52pBNwowL2AVdAvan2Kz8xwARrWe-52HdDTK9Qbs'; // 実際のキーに置き換えてください
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ユーザーID生成（ブラウザ固有）
        function getUserId() {
            let userId = localStorage.getItem('study_app_user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
                localStorage.setItem('study_app_user_id', userId);
            }
            return userId;
        }

        class StudyApp {
            constructor() {
                this.currentSubject = null;
                this.questions = [];
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.totalQuestions = 0;
                this.isAnswered = false;
                
                this.init();
            }

            init() {
                this.bindEvents();
                this.updateUI();
            }

            bindEvents() {
                // 科目選択
                document.querySelectorAll('.subject-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectSubject(e.target.dataset.subject);
                    });
                });

                // 問題生成
                document.getElementById('generate-questions').addEventListener('click', () => {
                    this.generateQuestions();
                });

                // プロンプト生成
                document.getElementById('generate-prompt').addEventListener('click', () => {
                    this.generatePrompt();
                });

                // 問題インポート
                document.getElementById('import-questions').addEventListener('click', () => {
                    this.showImportArea();
                });

                // プロンプトコピー
                document.getElementById('copy-prompt').addEventListener('click', () => {
                    this.copyPrompt();
                });

                // インポート処理
                document.getElementById('process-import').addEventListener('click', () => {
                    this.processImport();
                });

                // 学習開始
                document.getElementById('start-quiz').addEventListener('click', () => {
                    this.startQuiz();
                });

                // 回答送信
                document.getElementById('submit-answer').addEventListener('click', () => {
                    this.submitAnswer();
                });

                // 次の問題
                document.getElementById('next-question').addEventListener('click', () => {
                    this.nextQuestion();
                });

                // 進捗リセット
                document.getElementById('reset-progress').addEventListener('click', () => {
                    this.resetProgress();
                });

                // 問題管理
                document.getElementById('show-questions').addEventListener('click', () => {
                    this.showQuestionList();
                });

                document.getElementById('clear-subject-data').addEventListener('click', () => {
                    this.clearSubjectData();
                });

                // APIキー管理
                document.getElementById('manage-api-key').addEventListener('click', () => {
                    this.manageAPIKey();
                });

                // デバッグ情報
                document.getElementById('debug-info').addEventListener('click', () => {
                    this.showDebugInfo();
                });

                // データエクスポート
                document.getElementById('export-data').addEventListener('click', () => {
                    this.exportData();
                });

                // データインポート
                document.getElementById('import-data').addEventListener('click', () => {
                    this.showDataImportArea();
                });

                // データインポート処理
                document.getElementById('process-data-import').addEventListener('click', () => {
                    this.processDataImport();
                });

                // ユーザーID設定
                document.getElementById('set-user-id').addEventListener('click', () => {
                    this.setUserId();
                });

                // クラウド保存
                document.getElementById('save-to-cloud').addEventListener('click', () => {
                    this.saveToCloud();
                });

                // クラウド読み込み
                document.getElementById('load-from-cloud').addEventListener('click', () => {
                    this.loadFromCloud();
                });

                // Enter キーで回答送信
                document.getElementById('fill-blank-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.submitAnswer();
                    }
                });
            }

            selectSubject(subject) {
                this.currentSubject = subject;
                
                // ボタンの状態更新
                document.querySelectorAll('.subject-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-subject="${subject}"]`).classList.add('active');

                this.loadSubjectData();
                this.updateUI();
            }

            loadSubjectData() {
                const key = `study_app_${this.currentSubject}`;
                const data = localStorage.getItem(key);
                
                if (data) {
                    const parsed = JSON.parse(data);
                    this.questions = parsed.questions || [];
                    this.score = parsed.score || 0;
                    this.totalQuestions = parsed.totalQuestions || 0;
                } else {
                    this.questions = [];
                    this.score = 0;
                    this.totalQuestions = 0;
                }
            }

            saveSubjectData() {
                const key = `study_app_${this.currentSubject}`;
                const data = {
                    questions: this.questions,
                    score: this.score,
                    totalQuestions: this.totalQuestions
                };
                localStorage.setItem(key, JSON.stringify(data));
            }

            updateUI() {
                if (!this.currentSubject) {
                    document.getElementById('generate-section').classList.add('hidden');
                    document.getElementById('study-section').classList.add('hidden');
                    document.getElementById('management-section').classList.add('hidden');
                    return;
                }

                document.getElementById('generate-section').classList.remove('hidden');
                document.getElementById('management-section').classList.remove('hidden');

                if (this.questions.length > 0) {
                    document.getElementById('study-section').classList.remove('hidden');
                    document.getElementById('score').textContent = this.score;
                    document.getElementById('total').textContent = this.totalQuestions;
                    const percentage = this.totalQuestions > 0 ? Math.round((this.score / this.totalQuestions) * 100) : 0;
                    document.getElementById('percentage').textContent = percentage;
                    
                    const progress = this.totalQuestions > 0 ? (this.score / this.totalQuestions) * 100 : 0;
                    document.getElementById('progress-fill').style.width = `${progress}%`;
                } else {
                    document.getElementById('study-section').classList.add('hidden');
                }

                document.getElementById('question-count').textContent = this.questions.length;
                
                // ユーザーID表示更新
                this.updateUserIdDisplay();
            }

            updateUserIdDisplay() {
                const currentUserId = getUserId();
                document.getElementById('current-user-id').textContent = currentUserId;
            }

            async generateQuestions() {
                const memo = document.getElementById('memo-input').value.trim();
                
                if (!memo) {
                    alert('授業メモを入力してください。');
                    return;
                }

                // APIキーの確認
                let apiKey = localStorage.getItem('anthropic_api_key');
                if (!apiKey) {
                    apiKey = prompt('Anthropic APIキーを入力してください（今後のために保存されます）:');
                    if (!apiKey) {
                        alert('APIキーが必要です。');
                        return;
                    }
                    localStorage.setItem('anthropic_api_key', apiKey);
                }

                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('generate-questions').disabled = true;

                try {
                    // Claude AIで問題生成
                    const questions = await this.callClaudeAPI(memo, apiKey);
                    
                    this.questions = questions;
                    this.saveSubjectData();
                    this.updateUI();
                    
                    document.getElementById('memo-input').value = '';
                    alert('問題を生成しました！');
                    
                } catch (error) {
                    console.error('API Error:', error);
                    
                    // APIエラーの場合はサンプル問題で代替
                    if (confirm('AI API接続でエラーが発生しました。サンプル問題で代替しますか？')) {
                        const sampleQuestions = this.generateSampleQuestions(memo);
                        this.questions = sampleQuestions;
                        this.saveSubjectData();
                        this.updateUI();
                        document.getElementById('memo-input').value = '';
                        alert('サンプル問題を生成しました！');
                    }
                } finally {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('generate-questions').disabled = false;
                }
            }

            generateSampleQuestions(memo) {
                // AI APIの代わりにサンプル問題を生成（実装時はAI APIに置き換え）
                const sampleQuestions = [];
                const words = memo.split(/\s+/).filter(word => word.length > 2);
                
                for (let i = 0; i < Math.min(15, words.length); i++) {
                    const word = words[i];
                    
                    if (i % 2 === 0) {
                        // 選択肢問題
                        sampleQuestions.push({
                            type: 'multiple',
                            question: `「${word}」について正しい説明はどれですか？`,
                            options: [
                                `${word}は重要な概念である`,
                                `${word}は関係のない要素である`,
                                `${word}は古い理論である`,
                                `${word}は間違った考え方である`
                            ],
                            correctAnswer: 0
                        });
                    } else {
                        // 穴埋め問題
                        sampleQuestions.push({
                            type: 'fillblank',
                            question: `授業で学んだ重要な概念「____」について説明してください。`,
                            correctAnswer: word
                        });
                    }
                }
                
                return sampleQuestions;
            }

            async callClaudeAPI(memo, apiKey) {
                const apiUrl = 'https://api.anthropic.com/v1/messages';
                
                const prompt = `以下の授業メモから、15問の1問1答問題を作成してください。
選択肢問題と穴埋め問題を半々程度で混在させてください。
選択肢問題は4択で、1つの正解と3つの間違った選択肢を作成してください。
穴埋め問題は重要なキーワードを答えとしてください。

授業メモ:
${memo}

JSONのみで回答してください（説明文は不要）:
[
  {
    "type": "multiple",
    "question": "問題文",
    "options": ["選択肢1", "選択肢2", "選択肢3", "選択肢4"],
    "correctAnswer": 0
  },
  {
    "type": "fillblank", 
    "question": "____に入る語句は何ですか？",
    "correctAnswer": "正解の語句"
  }
]`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-sonnet-20240229',
                        max_tokens: 4000,
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorData}`);
                }

                const data = await response.json();
                const content = data.content[0].text;
                
                // JSONの抽出
                let jsonStr = content;
                const jsonMatch = content.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
                if (jsonMatch) {
                    jsonStr = jsonMatch[1];
                } else {
                    const arrayMatch = content.match(/\[[\s\S]*\]/);
                    if (arrayMatch) {
                        jsonStr = arrayMatch[0];
                    }
                }
                
                try {
                    return JSON.parse(jsonStr);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.error('Response content:', content);
                    throw new Error('Claude APIの応答をJSONとして解析できませんでした');
                }
            }

            generatePrompt() {
                const memo = document.getElementById('memo-input').value.trim();
                
                if (!memo) {
                    alert('授業メモを入力してください。');
                    return;
                }

                const prompt = `以下の授業メモから、15問の1問1答問題を作成してください。
選択肢問題と穴埋め問題を半々程度で混在させてください。
選択肢問題は4択で、1つの正解と3つの間違った選択肢を作成してください。
穴埋め問題は重要なキーワードを答えとしてください。

授業メモ:
${memo}

必ず以下のJSON形式のみで回答してください（説明文や追加のテキストは一切不要）:
[
  {
    "type": "multiple",
    "question": "問題文",
    "options": ["選択肢1", "選択肢2", "選択肢3", "選択肢4"],
    "correctAnswer": 0
  },
  {
    "type": "fillblank", 
    "question": "____に入る語句は何ですか？",
    "correctAnswer": "正解の語句"
  }
]`;

                document.getElementById('prompt-text').value = prompt;
                document.getElementById('prompt-display').classList.remove('hidden');
                document.getElementById('import-area').classList.add('hidden');
            }

            copyPrompt() {
                const promptText = document.getElementById('prompt-text');
                promptText.select();
                document.execCommand('copy');
                alert('プロンプトをコピーしました！Claude AIに貼り付けて実行してください。');
            }

            showImportArea() {
                document.getElementById('import-area').classList.remove('hidden');
                document.getElementById('prompt-display').classList.add('hidden');
            }

            processImport() {
                const importText = document.getElementById('import-text').value.trim();
                
                if (!importText) {
                    alert('Claude AIの回答を貼り付けてください。');
                    return;
                }

                try {
                    // JSONの抽出を試行
                    let jsonStr = importText;
                    
                    // コードブロックで囲まれている場合
                    const jsonMatch = importText.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
                    if (jsonMatch) {
                        jsonStr = jsonMatch[1];
                    } else {
                        // [ で始まり ] で終わるJSONを抽出
                        const arrayMatch = importText.match(/\[[\s\S]*\]/);
                        if (arrayMatch) {
                            jsonStr = arrayMatch[0];
                        }
                    }
                    
                    const questions = JSON.parse(jsonStr);
                    
                    // 問題形式の検証
                    if (!Array.isArray(questions)) {
                        throw new Error('問題は配列形式である必要があります');
                    }
                    
                    for (const q of questions) {
                        if (!q.type || !q.question) {
                            throw new Error('問題にtype, questionが必要です');
                        }
                        if (q.type === 'multiple' && (!q.options || !q.hasOwnProperty('correctAnswer'))) {
                            throw new Error('選択肢問題にはoptions, correctAnswerが必要です');
                        }
                        if (q.type === 'fillblank' && !q.correctAnswer) {
                            throw new Error('穴埋め問題にはcorrectAnswerが必要です');
                        }
                    }
                    
                    // 既存の問題に追加
                    this.questions = [...this.questions, ...questions];
                    this.saveSubjectData();
                    this.updateUI();
                    
                    // UI リセット
                    document.getElementById('memo-input').value = '';
                    document.getElementById('import-text').value = '';
                    document.getElementById('import-area').classList.add('hidden');
                    document.getElementById('prompt-display').classList.add('hidden');
                    
                    alert(`${questions.length}問の問題をインポートしました！`);
                    
                } catch (error) {
                    alert(`インポートエラー: ${error.message}\n\nJSON形式が正しいか確認してください。`);
                    console.error('Import error:', error);
                    console.error('Import text:', importText);
                }
            }

            startQuiz() {
                this.currentQuestionIndex = 0;
                this.isAnswered = false;
                
                document.getElementById('quiz-section').style.display = 'block';
                this.showQuestion();
            }

            showQuestion() {
                if (this.currentQuestionIndex >= this.questions.length) {
                    this.endQuiz();
                    return;
                }

                const question = this.questions[this.currentQuestionIndex];
                document.getElementById('question-text').textContent = 
                    `問題 ${this.currentQuestionIndex + 1}/${this.questions.length}: ${question.question}`;

                const optionsContainer = document.getElementById('options-container');
                const fillBlankInput = document.getElementById('fill-blank-input');
                const submitBtn = document.getElementById('submit-answer');
                const nextBtn = document.getElementById('next-question');

                // リセット
                optionsContainer.innerHTML = '';
                fillBlankInput.classList.add('hidden');
                submitBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
                this.isAnswered = false;

                if (question.type === 'multiple') {
                    // 選択肢問題
                    question.options.forEach((option, index) => {
                        const btn = document.createElement('button');
                        btn.className = 'option-btn';
                        btn.textContent = option;
                        btn.addEventListener('click', () => this.selectOption(index, btn));
                        optionsContainer.appendChild(btn);
                    });
                } else if (question.type === 'fillblank') {
                    // 穴埋め問題
                    fillBlankInput.classList.remove('hidden');
                    fillBlankInput.value = '';
                    submitBtn.classList.remove('hidden');
                }
            }

            selectOption(index, btnElement) {
                if (this.isAnswered) return;

                const question = this.questions[this.currentQuestionIndex];
                const correct = index === question.correctAnswer;

                // 全ての選択肢ボタンを無効化
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.style.pointerEvents = 'none';
                });

                // 正解・不正解の表示
                if (correct) {
                    btnElement.classList.add('correct');
                    this.score++;
                } else {
                    btnElement.classList.add('incorrect');
                    // 正解も表示
                    document.querySelectorAll('.option-btn')[question.correctAnswer].classList.add('correct');
                }

                this.totalQuestions++;
                this.isAnswered = true;
                this.saveSubjectData();
                this.updateUI();

                document.getElementById('next-question').classList.remove('hidden');
            }

            submitAnswer() {
                if (this.isAnswered) return;

                const userAnswer = document.getElementById('fill-blank-input').value.trim();
                const question = this.questions[this.currentQuestionIndex];

                if (!userAnswer) {
                    alert('答えを入力してください。');
                    return;
                }

                const correct = userAnswer.toLowerCase() === question.correctAnswer.toLowerCase();

                if (correct) {
                    alert('正解！');
                    this.score++;
                } else {
                    alert(`不正解。正解は「${question.correctAnswer}」です。`);
                }

                this.totalQuestions++;
                this.isAnswered = true;
                this.saveSubjectData();
                this.updateUI();

                document.getElementById('submit-answer').classList.add('hidden');
                document.getElementById('next-question').classList.remove('hidden');
            }

            nextQuestion() {
                this.currentQuestionIndex++;
                this.showQuestion();
            }

            endQuiz() {
                document.getElementById('quiz-section').style.display = 'none';
                const percentage = Math.round((this.score / this.totalQuestions) * 100);
                alert(`学習完了！正解率: ${percentage}%`);
            }

            resetProgress() {
                if (confirm('進捗をリセットしますか？')) {
                    this.score = 0;
                    this.totalQuestions = 0;
                    this.saveSubjectData();
                    this.updateUI();
                }
            }

            showQuestionList() {
                const listElement = document.getElementById('question-list');
                
                if (listElement.classList.contains('hidden')) {
                    listElement.innerHTML = '';
                    this.questions.forEach((q, index) => {
                        const item = document.createElement('div');
                        item.className = 'question-item';
                        item.innerHTML = `
                            <strong>Q${index + 1}:</strong> ${q.question}
                            <button class="delete-btn" onclick="app.deleteQuestion(${index})">削除</button>
                        `;
                        listElement.appendChild(item);
                    });
                    listElement.classList.remove('hidden');
                } else {
                    listElement.classList.add('hidden');
                }
            }

            deleteQuestion(index) {
                if (confirm('この問題を削除しますか？')) {
                    this.questions.splice(index, 1);
                    this.saveSubjectData();
                    this.updateUI();
                    this.showQuestionList();
                }
            }

            clearSubjectData() {
                if (confirm(`${this.currentSubject}のデータを全て削除しますか？`)) {
                    const key = `study_app_${this.currentSubject}`;
                    localStorage.removeItem(key);
                    this.questions = [];
                    this.score = 0;
                    this.totalQuestions = 0;
                    this.updateUI();
                    document.getElementById('question-list').classList.add('hidden');
                }
            }

            manageAPIKey() {
                const currentKey = localStorage.getItem('anthropic_api_key');
                let message = 'Anthropic APIキー管理\n\n';
                
                if (currentKey) {
                    message += `現在のキー: ${currentKey.substring(0, 10)}...\n\n`;
                    message += '1. 新しいキーを入力\n2. キーを削除\n3. キャンセル';
                    
                    const choice = prompt(message + '\n\n選択してください (1/2/3):');
                    
                    if (choice === '1') {
                        const newKey = prompt('新しいAnthropic APIキーを入力してください:');
                        if (newKey) {
                            localStorage.setItem('anthropic_api_key', newKey);
                            alert('APIキーを更新しました。');
                        }
                    } else if (choice === '2') {
                        if (confirm('APIキーを削除しますか？')) {
                            localStorage.removeItem('anthropic_api_key');
                            alert('APIキーを削除しました。');
                        }
                    }
                } else {
                    const newKey = prompt('Anthropic APIキーを入力してください:');
                    if (newKey) {
                        localStorage.setItem('anthropic_api_key', newKey);
                        alert('APIキーを保存しました。');
                    }
                }
            }

            showDebugInfo() {
                const apiKey = localStorage.getItem('anthropic_api_key');
                
                let debug = '=== デバッグ情報 ===\n\n';
                debug += `現在の科目: ${this.currentSubject || 'なし'}\n`;
                debug += `APIキー: ${apiKey ? `設定済み (${apiKey.substring(0, 10)}...)` : '未設定'}\n`;
                debug += `問題数: ${this.questions.length}\n`;
                debug += `正解/総問題: ${this.score}/${this.totalQuestions}\n`;
                debug += `画面幅: ${window.innerWidth}px\n`;
                debug += `ユーザーエージェント: ${navigator.userAgent.includes('Mobile') ? 'モバイル' : 'デスクトップ'}\n\n`;
                
                debug += '=== UI表示状態 ===\n';
                debug += `generate-section: ${document.getElementById('generate-section').classList.contains('hidden') ? '非表示' : '表示'}\n`;
                debug += `study-section: ${document.getElementById('study-section').classList.contains('hidden') ? '非表示' : '表示'}\n`;
                debug += `management-section: ${document.getElementById('management-section').classList.contains('hidden') ? '非表示' : '表示'}\n\n`;
                
                debug += '=== LocalStorage内容 ===\n';
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    if (key.startsWith('study_app_') || key === 'anthropic_api_key') {
                        debug += `${key}: ${value ? '設定済み' : '空'}\n`;
                    }
                }
                
                alert(debug);
            }

            // Supabase関連メソッド

            async saveToCloud() {
                try {
                    const button = document.getElementById('save-to-cloud');
                    button.disabled = true;
                    button.textContent = '保存中...';

                    const userId = getUserId();
                    let savedCount = 0;

                    // 全科目のデータをクラウドに保存
                    for (const subject of ['decision', 'philosophy', 'communication']) {
                        const key = `study_app_${subject}`;
                        const localData = localStorage.getItem(key);
                        
                        if (localData) {
                            const parsedData = JSON.parse(localData);
                            
                            // 問題が存在する場合のみ保存
                            if (parsedData.questions && parsedData.questions.length > 0) {
                                const data = {
                                    user_id: userId,
                                    subject: subject,
                                    questions: parsedData.questions,
                                    score: parsedData.score || 0,
                                    total_questions: parsedData.totalQuestions || 0,
                                    updated_at: new Date().toISOString()
                                };

                                const { error } = await supabase
                                    .from('study_data')
                                    .upsert(data, { onConflict: 'user_id,subject' });

                                if (error) throw error;
                                savedCount++;
                            }
                        }
                    }

                    alert(`クラウド保存完了！${savedCount}科目のデータを保存しました。`);

                } catch (error) {
                    console.error('保存エラー:', error);
                    alert('保存でエラーが発生しました: ' + error.message);
                } finally {
                    const button = document.getElementById('save-to-cloud');
                    button.disabled = false;
                    button.textContent = '📤 クラウドに保存';
                }
            }

            async loadFromCloud() {
                try {
                    const button = document.getElementById('load-from-cloud');
                    button.disabled = true;
                    button.textContent = '読み込み中...';

                    const userId = getUserId();
                    const { data, error } = await supabase
                        .from('study_data')
                        .select('*')
                        .eq('user_id', userId);

                    if (error) throw error;

                    if (data.length === 0) {
                        alert('クラウドにデータが見つかりませんでした。\n\n先に他のデバイスで「📤 クラウドに保存」を実行してください。');
                        return;
                    }

                    // LocalStorage に保存
                    data.forEach(item => {
                        const key = `study_app_${item.subject}`;
                        const localData = {
                            questions: item.questions || [],
                            score: item.score || 0,
                            totalQuestions: item.total_questions || 0
                        };
                        localStorage.setItem(key, JSON.stringify(localData));
                    });

                    // 現在の科目データを再読み込み
                    if (this.currentSubject) {
                        this.loadSubjectData();
                        this.updateUI();
                    }

                    alert(`クラウド読み込み完了！${data.length}科目のデータを読み込みました。\n\n科目を選択して学習を開始してください。`);

                } catch (error) {
                    console.error('読み込みエラー:', error);
                    alert('読み込みでエラーが発生しました: ' + error.message);
                } finally {
                    const button = document.getElementById('load-from-cloud');
                    button.disabled = false;
                    button.textContent = '📥 クラウドから読み込み';
                }
            }

            exportData() {
                const allData = {
                    exportDate: new Date().toISOString().split('T')[0],
                    userId: getUserId(),
                    subjects: {}
                };

                ['decision', 'philosophy', 'communication'].forEach(subject => {
                    const key = `study_app_${subject}`;
                    const data = localStorage.getItem(key);
                    if (data) {
                        allData.subjects[subject] = JSON.parse(data);
                    }
                });

                const jsonStr = JSON.stringify(allData, null, 2);
                
                // クリップボードにコピー
                navigator.clipboard.writeText(jsonStr).then(() => {
                    alert('データをクリップボードにコピーしました！他のデバイスで「データインポート」に貼り付けてください。');
                }).catch(() => {
                    // フォールバック：テキストエリアに表示
                    const textarea = document.createElement('textarea');
                    textarea.value = jsonStr;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('データをコピーしました！他のデバイスで「データインポート」に貼り付けてください。');
                });
            }

            showDataImportArea() {
                document.getElementById('data-import-area').classList.remove('hidden');
            }

            processDataImport() {
                const importText = document.getElementById('import-data-text').value.trim();
                
                if (!importText) {
                    alert('エクスポートしたデータを貼り付けてください。');
                    return;
                }

                try {
                    const data = JSON.parse(importText);
                    
                    if (!data.subjects) {
                        throw new Error('無効なデータ形式です');
                    }

                    // LocalStorageに保存
                    Object.entries(data.subjects).forEach(([subject, subjectData]) => {
                        const key = `study_app_${subject}`;
                        localStorage.setItem(key, JSON.stringify(subjectData));
                    });

                    // 現在の科目データを再読み込み
                    if (this.currentSubject) {
                        this.loadSubjectData();
                        this.updateUI();
                    }

                    document.getElementById('import-data-text').value = '';
                    document.getElementById('data-import-area').classList.add('hidden');
                    
                    alert(`データインポート完了！${Object.keys(data.subjects).length}科目のデータをインポートしました。`);
                    
                } catch (error) {
                    alert(`インポートエラー: ${error.message}`);
                }
            }

            setUserId() {
                const newUserId = document.getElementById('user-id-input').value.trim();
                
                if (!newUserId) {
                    alert('ユーザーIDを入力してください。');
                    return;
                }

                // ID形式の簡単な検証
                if (newUserId.length < 3) {
                    alert('ユーザーIDは3文字以上で入力してください。');
                    return;
                }

                if (!/^[a-zA-Z0-9_-]+$/.test(newUserId)) {
                    alert('ユーザーIDは英数字、ハイフン、アンダースコアのみ使用できます。');
                    return;
                }

                const currentUserId = localStorage.getItem('study_app_user_id');
                
                if (currentUserId && currentUserId !== newUserId) {
                    if (!confirm(`現在のユーザーID「${currentUserId}」を「${newUserId}」に変更しますか？\n\n注意: 変更後はクラウド同期でデータを再取得する必要があります。`)) {
                        return;
                    }
                }

                // ユーザーID設定
                localStorage.setItem('study_app_user_id', newUserId);
                this.updateUserIdDisplay();
                document.getElementById('user-id-input').value = '';

                alert(`ユーザーIDを「${newUserId}」に設定しました！\n\n他のデバイスでも同じIDを設定してクラウド同期を行ってください。`);
            }
        }

        // アプリ初期化
        const app = new StudyApp();
    </script>
</body>
</html>
