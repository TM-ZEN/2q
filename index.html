<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1å•1ç­”å­¦ç¿’ã‚¢ãƒ—ãƒª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .app-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .app-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .subject-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .subject-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: #f8f9fa;
            color: #333;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            min-height: 60px;
            word-wrap: break-word;
        }
        
        .subject-btn:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .subject-btn.active {
            background: #667eea;
            color: white;
            border-color: #5a67d8;
        }
        
        .chapter-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .chapter-btn {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            min-height: 50px;
            display: flex;
            align-items: center;
            flex-direction: column;
            justify-content: center;
        }
        
        .chapter-btn:hover {
            border-color: #667eea;
            background: #e9ecef;
        }
        
        .chapter-btn.selected {
            background: #667eea;
            color: white;
            border-color: #5a67d8;
        }
        
        .chapter-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .chapter-btn.selected .chapter-info {
            color: #e0e6ff;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .app-header h1 {
                font-size: 2em;
            }
            
            .subject-selector {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .subject-btn {
                font-size: 18px;
                padding: 20px;
                min-height: 70px;
            }
            
            .chapter-selector {
                grid-template-columns: 1fr;
            }
            
            .generate-btn, .action-btn {
                font-size: 14px;
                padding: 10px 15px;
                margin: 5px 2px;
                display: block;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .memo-input {
                font-size: 16px;
            }
            
            .question-text {
                font-size: 16px;
            }
            
            .option-btn {
                font-size: 14px;
                padding: 12px;
            }
            
            .card {
                padding: 20px;
                margin-bottom: 15px;
            }
        }
        
        .input-section {
            margin: 20px 0;
        }
        
        .input-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
        }
        
        .memo-input {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }
        
        .memo-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .generate-btn, .action-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background 0.3s ease;
        }
        
        .generate-btn:hover, .action-btn:hover {
            background: #5a67d8;
        }
        
        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .quiz-section {
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s ease;
        }
        
        .question-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }
        
        .question-text {
            font-size: 18px;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .options {
            display: grid;
            gap: 10px;
        }
        
        .option-btn {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option-btn:hover {
            border-color: #667eea;
        }
        
        .option-btn.correct {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .option-btn.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .fill-blank-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .score-display {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            color: #555;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            color: #667eea;
            font-style: italic;
        }
        
        .management-section {
            margin-top: 30px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }
        
        .question-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .question-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            float: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header">
            <h1>ğŸ“š 1å•1ç­”å­¦ç¿’ã‚¢ãƒ—ãƒª</h1>
            <p>åŠ¹ç‡çš„ãªã‚¹ã‚­ãƒæ™‚é–“å­¦ç¿’ã§ç›®æ¨™é”æˆï¼</p>
        </div>

        <div class="card">
            <h2>å­¦ç¿’è¨­å®š</h2>
            
            <h3>ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
            <div class="subject-selector">
                <button class="subject-btn" data-subject="kigyoukeiei">ä¼æ¥­çµŒå–¶</button>
                <button class="subject-btn" data-subject="shinrigaku">å¿ƒç†å­¦</button>
            </div>

            <div id="chapter-section" class="hidden" style="margin-top: 20px;">
                <h3>å­¦ç¿’ã™ã‚‹ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</h3>
                <div id="chapter-selector" class="chapter-selector"></div>
                <div style="margin-top: 15px;">
                    <button id="select-all-chapters" class="action-btn" style="background: #28a745;">ã™ã¹ã¦é¸æŠ</button>
                    <button id="deselect-all-chapters" class="action-btn" style="background: #dc3545;">é¸æŠè§£é™¤</button>
                </div>
            </div>

            <div id="generate-section" class="hidden">
                <h3>å•é¡Œç”Ÿæˆ</h3>
                <div class="input-section">
                    <label for="chapter-name-input">ãƒãƒ£ãƒ—ã‚¿ãƒ¼å:</label>
                    <input type="text" id="chapter-name-input" class="memo-input" style="height: 40px;" placeholder="ä¾‹: 1, 2, 3">
                </div>
                <div class="input-section">
                    <label for="memo-input">æˆæ¥­ãƒ¡ãƒ¢ã‚’è²¼ã‚Šä»˜ã‘ã¦å•é¡Œã‚’ç”Ÿæˆï¼š</label>
                    <textarea id="memo-input" class="memo-input" placeholder="æˆæ¥­ãƒ¡ãƒ¢ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="generate-questions" class="generate-btn">AIã§å•é¡Œç”Ÿæˆ (å®Ÿé¨“çš„)</button>
                    <button id="generate-prompt" class="generate-btn" style="background: #28a745;">Claudeç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ</button>
                    <button id="import-questions" class="generate-btn" style="background: #fd7e14;">ç”Ÿæˆæ¸ˆã¿å•é¡Œã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                </div>
                
                <div id="loading" class="loading hidden">å•é¡Œã‚’ç”Ÿæˆä¸­...</div>
                
                <div id="prompt-display" class="hidden" style="margin-top: 20px;">
                    <label>ä»¥ä¸‹ã‚’Claude AIã«ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ï¼š</label>
                    <textarea id="prompt-text" class="memo-input" readonly style="background: #f8f9fa; height: 150px;"></textarea>
                    <button id="copy-prompt" class="action-btn">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
                </div>
                
                <div id="import-area" class="hidden" style="margin-top: 20px;">
                    <label>Claude AIã®å›ç­”ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š</label>
                    <textarea id="import-text" class="memo-input" placeholder="Claude AIãŒç”Ÿæˆã—ãŸJSONå½¢å¼ã®å•é¡Œã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>
                    <button id="process-import" class="action-btn">å•é¡Œã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                </div>
            </div>

            <div id="study-section" class="hidden">
                <div class="score-display">
                    æ­£è§£ç‡: <span id="score">0</span>/<span id="total">0</span> (<span id="percentage">0</span>%)
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <button id="start-quiz" class="action-btn">å­¦ç¿’é–‹å§‹ (15å•)</button>
                <button id="reset-progress" class="action-btn">é€²æ—ãƒªã‚»ãƒƒãƒˆ</button>
            </div>

            <div id="quiz-section" class="quiz-section">
                <div class="question-card">
                    <div class="question-text" id="question-text"></div>
                    <div id="options-container"></div>
                    <input type="text" id="fill-blank-input" class="fill-blank-input hidden" placeholder="ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                    <button id="submit-answer" class="action-btn hidden">å›ç­”</button>
                    <button id="next-question" class="action-btn hidden">æ¬¡ã®å•é¡Œ</button>
                </div>
            </div>

            <div id="management-section" class="management-section hidden">
                <h3>å•é¡Œç®¡ç†</h3>
                <p>ä¿å­˜æ¸ˆã¿å•é¡Œæ•°: <span id="question-count">0</span></p>
                <button id="show-questions" class="action-btn">å•é¡Œä¸€è¦§è¡¨ç¤º</button>
                <button id="clear-subject-data" class="action-btn" style="background: #dc3545;">ç§‘ç›®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
                <button id="manage-api-key" class="action-btn" style="background: #6c757d;">APIã‚­ãƒ¼ç®¡ç†</button>
                <button id="debug-info" class="action-btn" style="background: #17a2b8;">ãƒ‡ãƒãƒƒã‚°æƒ…å ±</button>
                
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                    <h4>ğŸ“± ãƒ‡ãƒã‚¤ã‚¹é–“ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ</h4>
                    <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <label style="font-weight: bold; margin-bottom: 5px; display: block;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</label>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="user-id-input" placeholder="å…±æœ‰ç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›" style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <button id="set-user-id" class="action-btn" style="background: #6f42c1;">IDè¨­å®š</button>
                        </div>
                        <small style="color: #666; margin-top: 5px; display: block;">
                            ç¾åœ¨ã®ID: <span id="current-user-id">æœªè¨­å®š</span>
                        </small>
                    </div>
                    
                    <button id="export-data" class="action-btn" style="background: #28a745;">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button id="import-data" class="action-btn" style="background: #fd7e14;">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    <button id="save-to-cloud" class="action-btn" style="background: #007bff;">ğŸ“¤ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜</button>
                    <button id="load-from-cloud" class="action-btn" style="background: #17a2b8;">ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿</button>
                </div>
                
                <div id="data-import-area" class="hidden" style="margin-top: 15px;">
                    <label>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š</label>
                    <textarea id="import-data-text" class="memo-input" style="height: 100px;" placeholder="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."></textarea>
                    <button id="process-data-import" class="action-btn">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                </div>
                <div id="question-list" class="question-list hidden"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://zayngisercbordbjzats.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpheW5naXNlcmNib3JkYmp6YXRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMTY4NzEsImV4cCI6MjA3MDg5Mjg3MX0.kRO52pBNwowL2AVdAvan2Kz8xwARrWe-52HdDTK9Qbs';
        let supabaseClient = null;

        function getUserId() {
            let userId = localStorage.getItem('study_app_user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
                localStorage.setItem('study_app_user_id', userId);
            }
            return userId;
        }

        class StudyApp {
            constructor() {
                this.currentSubject = null;
                this.selectedChapters = [];
                this.allChapters = {};
                this.questions = [];
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.totalQuestions = 0;
                this.isAnswered = false;
                
                this.init();
            }

            init() {
                this.bindEvents();
                this.updateUI();
            }

            bindEvents() {
                document.querySelectorAll('.subject-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectSubject(e.target.dataset.subject);
                    });
                });

                document.getElementById('select-all-chapters').addEventListener('click', () => {
                    this.selectAllChapters();
                });

                document.getElementById('deselect-all-chapters').addEventListener('click', () => {
                    this.deselectAllChapters();
                });

                document.getElementById('generate-questions').addEventListener('click', () => {
                    this.generateQuestions();
                });

                document.getElementById('generate-prompt').addEventListener('click', () => {
                    this.generatePrompt();
                });

                document.getElementById('import-questions').addEventListener('click', () => {
                    this.showImportArea();
                });

                document.getElementById('copy-prompt').addEventListener('click', () => {
                    this.copyPrompt();
                });

                document.getElementById('process-import').addEventListener('click', () => {
                    this.processImport();
                });

                document.getElementById('start-quiz').addEventListener('click', () => {
                    this.startQuiz();
                });

                document.getElementById('submit-answer').addEventListener('click', () => {
                    this.submitAnswer();
                });

                document.getElementById('next-question').addEventListener('click', () => {
                    this.nextQuestion();
                });

                document.getElementById('reset-progress').addEventListener('click', () => {
                    this.resetProgress();
                });

                document.getElementById('show-questions').addEventListener('click', () => {
                    this.showQuestionList();
                });

                document.getElementById('clear-subject-data').addEventListener('click', () => {
                    this.clearSubjectData();
                });

                document.getElementById('manage-api-key').addEventListener('click', () => {
                    this.manageAPIKey();
                });

                document.getElementById('debug-info').addEventListener('click', () => {
                    this.showDebugInfo();
                });

                document.getElementById('export-data').addEventListener('click', () => {
                    this.exportData();
                });

                document.getElementById('import-data').addEventListener('click', () => {
                    this.showDataImportArea();
                });

                document.getElementById('process-data-import').addEventListener('click', () => {
                    this.processDataImport();
                });

                document.getElementById('set-user-id').addEventListener('click', () => {
                    this.setUserId();
                });

                document.getElementById('save-to-cloud').addEventListener('click', () => {
                    this.saveToCloud();
                });

                document.getElementById('load-from-cloud').addEventListener('click', () => {
                    this.loadFromCloud();
                });

                document.getElementById('fill-blank-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.submitAnswer();
                    }
                });
            }

            selectSubject(subject) {
                this.currentSubject = subject;
                this.selectedChapters = [];
                
                document.querySelectorAll('.subject-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-subject="${subject}"]`).classList.add('active');

                this.loadChaptersForSubject(subject);
                this.updateUI();
            }

            async loadChaptersForSubject(subject) {
                try {
                    const userId = getUserId();

                    // select()ã¯å¿…ãš from() ã®ç›´å¾Œã«æ¥ã‚‹å¿…è¦ãŒã‚ã‚‹
                    let query;
                    if (chapterColumnExists) {
                        query = supabaseClient
                            .from('study_data')
                            .select('chapter, questions, score, total_questions')
                            .eq('user_id', userId)
                            .eq('subject', subject)
                            .not('chapter', 'is', null);
                    } else {
                        query = supabaseClient
                            .from('study_data')
                            .select('questions, score, total_questions')
                            .eq('user_id', userId)
                            .eq('subject', subject);
                    }

                    const { data, error } = await query;
                    if (error) throw error;

                    if (chapterColumnExists) {
                        this.allChapters[subject] = data || [];
                    } else {
                        // chapteråˆ—ãªã—ã®å ´åˆã€1ä»¶ã ã‘ã®ã¯ãšãªã®ã§ 'default' ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã¨ã—ã¦æ‰±ã†
                        this.allChapters[subject] = (data || []).map(row => ({
                            ...row,
                            chapter: 'default'
                        }));
                    }

                    this.displayChapterSelector();
                    
                } catch (error) {
                    console.error('ãƒãƒ£ãƒ—ã‚¿ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', JSON.stringify(error, null, 2), error);
                    this.allChapters[subject] = [];
                    this.displayChapterSelector();
                }
            }

            displayChapterSelector() {
                const chapterSection = document.getElementById('chapter-section');
                const chapterSelector = document.getElementById('chapter-selector');
                
                if (!this.currentSubject) {
                    chapterSection.classList.add('hidden');
                    return;
                }

                const chapters = this.allChapters[this.currentSubject] || [];
                
                if (chapters.length === 0) {
                    chapterSection.classList.add('hidden');
                    return;
                }

                chapterSection.classList.remove('hidden');
                chapterSelector.innerHTML = '';

                chapters.forEach(chapterData => {
                    const btn = document.createElement('button');
                    btn.className = 'chapter-btn';
                    btn.dataset.chapter = chapterData.chapter;
                    
                    const questionCount = chapterData.questions ? chapterData.questions.length : 0;
                    const score = chapterData.score || 0;
                    const total = chapterData.total_questions || 0;
                    const percentage = total > 0 ? Math.round((score / total) * 100) : 0;
                    
                    btn.innerHTML = `
                        <div style="font-weight: bold;">ãƒãƒ£ãƒ—ã‚¿ãƒ¼ ${chapterData.chapter}</div>
                        <div class="chapter-info">å•é¡Œæ•°: ${questionCount} | æ­£è§£ç‡: ${percentage}%</div>
                    `;
                    
                    btn.addEventListener('click', () => {
                        this.toggleChapter(chapterData.chapter);
                    });
                    
                    chapterSelector.appendChild(btn);
                });
            }

            toggleChapter(chapter) {
                const index = this.selectedChapters.indexOf(chapter);
                if (index > -1) {
                    this.selectedChapters.splice(index, 1);
                } else {
                    this.selectedChapters.push(chapter);
                }
                
                this.updateChapterButtonStates();
                this.loadSelectedChaptersData();
                this.updateUI();
            }

            selectAllChapters() {
                const chapters = this.allChapters[this.currentSubject] || [];
                this.selectedChapters = chapters.map(c => c.chapter);
                this.updateChapterButtonStates();
                this.loadSelectedChaptersData();
                this.updateUI();
            }

            deselectAllChapters() {
                this.selectedChapters = [];
                this.updateChapterButtonStates();
                this.loadSelectedChaptersData();
                this.updateUI();
            }

            updateChapterButtonStates() {
                document.querySelectorAll('.chapter-btn').forEach(btn => {
                    if (this.selectedChapters.includes(btn.dataset.chapter)) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            }

            async loadSelectedChaptersData() {
                if (this.selectedChapters.length === 0) {
                    this.questions = [];
                    this.score = 0;
                    this.totalQuestions = 0;
                    return;
                }

                try {
                    const userId = getUserId();

                    let query = supabaseClient
                        .from('study_data')
                        .select('*')
                        .eq('user_id', userId)
                        .eq('subject', this.currentSubject);

                    if (chapterColumnExists) {
                        query = query.in('chapter', this.selectedChapters);
                    }
                    // chapteråˆ—ãŒãªã„å ´åˆã¯å…¨ä»¶å–å¾—ï¼ˆsubject ã§çµã£ã¦ã„ã‚‹ãŸã‚å•é¡Œãªã„ï¼‰

                    const { data, error } = await query;
                    if (error) throw error;

                    this.questions = [];
                    this.score = 0;
                    this.totalQuestions = 0;

                    data.forEach(chapterData => {
                        if (chapterData.questions && chapterData.questions.length > 0) {
                            const chapterLabel = chapterColumnExists ? chapterData.chapter : 'default';
                            const questionsWithChapter = chapterData.questions.map(q => ({
                                ...q,
                                chapter: chapterLabel
                            }));
                            this.questions = [...this.questions, ...questionsWithChapter];
                        }
                        this.score += chapterData.score || 0;
                        this.totalQuestions += chapterData.total_questions || 0;
                    });

                } catch (error) {
                    console.error('ãƒãƒ£ãƒ—ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', JSON.stringify(error, null, 2), error);
                }
            }

            updateUI() {
                if (!this.currentSubject) {
                    document.getElementById('generate-section').classList.add('hidden');
                    document.getElementById('study-section').classList.add('hidden');
                    document.getElementById('management-section').classList.add('hidden');
                    document.getElementById('chapter-section').classList.add('hidden');
                    return;
                }
            
                document.getElementById('generate-section').classList.remove('hidden');
                document.getElementById('management-section').classList.remove('hidden');
            
                if (this.selectedChapters.length > 0) {
                    document.getElementById('study-section').classList.remove('hidden');
                    document.getElementById('score').textContent = this.score;
                    document.getElementById('total').textContent = this.totalQuestions;
                    const percentage = this.totalQuestions > 0 ? Math.round((this.score / this.totalQuestions) * 100) : 0;
                    document.getElementById('percentage').textContent = percentage;
                    
                    const progress = this.totalQuestions > 0 ? (this.score / this.totalQuestions) * 100 : 0;
                    document.getElementById('progress-fill').style.width = `${progress}%`;
                } else {
                    document.getElementById('study-section').classList.add('hidden');
                }
            
                document.getElementById('question-count').textContent = this.questions.length;
                this.updateUserIdDisplay();
            }

            updateUserIdDisplay() {
                const currentUserId = getUserId();
                document.getElementById('current-user-id').textContent = currentUserId;
            }

            async generateQuestions() {
                const memo = document.getElementById('memo-input').value.trim();
                const chapterName = document.getElementById('chapter-name-input').value.trim();
                
                if (!memo) {
                    alert('æˆæ¥­ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                if (!chapterName) {
                    alert('ãƒãƒ£ãƒ—ã‚¿ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                let apiKey = localStorage.getItem('anthropic_api_key');
                if (!apiKey) {
                    apiKey = prompt('Anthropic APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»Šå¾Œã®ãŸã‚ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰:');
                    if (!apiKey) {
                        alert('APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚');
                        return;
                    }
                    localStorage.setItem('anthropic_api_key', apiKey);
                }

                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('generate-questions').disabled = true;

                try {
                    const questions = await this.callClaudeAPI(memo, apiKey);
                    await this.saveChapterData(chapterName, questions);
                    await this.loadChaptersForSubject(this.currentSubject);
                    
                    document.getElementById('memo-input').value = '';
                    document.getElementById('chapter-name-input').value = '';
                    alert(`ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã€Œ${chapterName}ã€ã®å•é¡Œã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼`);
                    
                } catch (error) {
                    console.error('API Error:', JSON.stringify(error, null, 2), error);
                    if (confirm('AI APIæ¥ç¶šã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚µãƒ³ãƒ—ãƒ«å•é¡Œã§ä»£æ›¿ã—ã¾ã™ã‹ï¼Ÿ')) {
                        const sampleQuestions = this.generateSampleQuestions(memo);
                        await this.saveChapterData(chapterName, sampleQuestions);
                        await this.loadChaptersForSubject(this.currentSubject);
                        
                        document.getElementById('memo-input').value = '';
                        document.getElementById('chapter-name-input').value = '';
                        alert(`ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã€Œ${chapterName}ã€ã®ã‚µãƒ³ãƒ—ãƒ«å•é¡Œã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼`);
                    }
                } finally {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('generate-questions').disabled = false;
                }
            }

            async saveChapterData(chapterName, questions) {
                try {
                    const userId = getUserId();
                    
                    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰
                    let fetchQuery = supabaseClient
                        .from('study_data')
                        .select('questions, score, total_questions')
                        .eq('user_id', userId)
                        .eq('subject', this.currentSubject);

                    if (chapterColumnExists) {
                        fetchQuery = fetchQuery.eq('chapter', chapterName);
                    }
                    fetchQuery = fetchQuery.single();

                    const { data: existingData, error: fetchError } = await fetchQuery;
                    // .single() ã§è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯errorã«ãªã‚‹ãŒã€ãã‚Œã¯æ­£å¸¸ï¼ˆæ–°è¦ã®å ´åˆï¼‰
                    
                    let allQuestions = questions;
                    let currentScore = 0;
                    let currentTotal = 0;
                    
                    if (existingData && existingData.questions && existingData.questions.length > 0) {
                        allQuestions = [...existingData.questions, ...questions];
                        currentScore = existingData.score || 0;
                        currentTotal = existingData.total_questions || 0;
                    }
                    
                    const data = {
                        user_id: userId,
                        subject: this.currentSubject,
                        questions: allQuestions,
                        score: currentScore,
                        total_questions: currentTotal,
                        updated_at: new Date().toISOString()
                    };

                    // chapteråˆ—ãŒã‚ã‚Œã°ä»˜ä¸ã™ã‚‹
                    if (chapterColumnExists) {
                        data.chapter = chapterName;
                    }
            
                    // upsert ã® conflictã‚«ãƒ©ãƒ ã‚‚ chapteråˆ—ã®æœ‰ç„¡ã§å¤‰ãˆã‚‹
                    const conflictColumns = chapterColumnExists
                        ? 'user_id,subject,chapter'
                        : 'user_id,subject';

                    const { error } = await supabaseClient
                        .from('study_data')
                        .upsert(data, { onConflict: conflictColumns });
            
                    if (error) throw error;
            
                    const isAddition = existingData && existingData.questions && existingData.questions.length > 0;
                    const message = isAddition 
                        ? `ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã€Œ${chapterName}ã€ã«${questions.length}å•ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ï¼ˆåˆè¨ˆ: ${allQuestions.length}å•ï¼‰`
                        : `ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã€Œ${chapterName}ã€ã«${questions.length}å•ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`;
                    
                    return { isAddition, totalQuestions: allQuestions.length, message };
            
                } catch (error) {
                    console.error('ãƒãƒ£ãƒ—ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', JSON.stringify(error, null, 2), error);
                    alert('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error.message || JSON.stringify(error)));
                    throw error;
                }
            }

            generateSampleQuestions(memo) {
                const sampleQuestions = [];
                const words = memo.split(/\s+/).filter(word => word.length > 2);
                
                for (let i = 0; i < Math.min(15, words.length); i++) {
                    const word = words[i];
                    if (i % 2 === 0) {
                        sampleQuestions.push({
                            type: 'multiple',
                            question: `ã€Œ${word}ã€ã«ã¤ã„ã¦æ­£ã—ã„èª¬æ˜ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ`,
                            options: [
                                `${word}ã¯é‡è¦ãªæ¦‚å¿µã§ã‚ã‚‹`,
                                `${word}ã¯é–¢ä¿‚ã®ãªã„è¦ç´ ã§ã‚ã‚‹`,
                                `${word}ã¯å¤ã„ç†è«–ã§ã‚ã‚‹`,
                                `${word}ã¯é–“é•ã£ãŸè€ƒãˆæ–¹ã§ã‚ã‚‹`
                            ],
                            correctAnswer: 0
                        });
                    } else {
                        sampleQuestions.push({
                            type: 'fillblank',
                            question: `æˆæ¥­ã§å­¦ã‚“ã é‡è¦ãªæ¦‚å¿µã€Œ____ã€ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚`,
                            correctAnswer: word
                        });
                    }
                }
                return sampleQuestions;
            }

            async callClaudeAPI(memo, apiKey) {
                const apiUrl = 'https://api.anthropic.com/v1/messages';
                
                const prompt = `ä»¥ä¸‹ã®æˆæ¥­ãƒ¡ãƒ¢ã‹ã‚‰ã€15å•ã®1å•1ç­”å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
é¸æŠè‚¢å•é¡Œã¨ç©´åŸ‹ã‚å•é¡Œã‚’åŠã€…ç¨‹åº¦ã§æ··åœ¨ã•ã›ã¦ãã ã•ã„ã€‚
é¸æŠè‚¢å•é¡Œã¯4æŠã§ã€1ã¤ã®æ­£è§£ã¨3ã¤ã®é–“é•ã£ãŸé¸æŠè‚¢ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
ç©´åŸ‹ã‚å•é¡Œã¯é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç­”ãˆã¨ã—ã¦ãã ã•ã„ã€‚

æˆæ¥­ãƒ¡ãƒ¢:
${memo}

JSONã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜æ–‡ã¯ä¸è¦ï¼‰:
[
  {
    "type": "multiple",
    "question": "å•é¡Œæ–‡",
    "options": ["é¸æŠè‚¢1", "é¸æŠè‚¢2", "é¸æŠè‚¢3", "é¸æŠè‚¢4"],
    "correctAnswer": 0
  },
  {
    "type": "fillblank", 
    "question": "____ã«å…¥ã‚‹èªå¥ã¯ä½•ã§ã™ã‹ï¼Ÿ",
    "correctAnswer": "æ­£è§£ã®èªå¥"
  }
]`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-sonnet-20240229',
                        max_tokens: 4000,
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorData}`);
                }

                const data = await response.json();
                const content = data.content[0].text;
                
                let jsonStr = content;
                const jsonMatch = content.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
                if (jsonMatch) {
                    jsonStr = jsonMatch[1];
                } else {
                    const arrayMatch = content.match(/\[[\s\S]*\]/);
                    if (arrayMatch) {
                        jsonStr = arrayMatch[0];
                    }
                }
                
                try {
                    return JSON.parse(jsonStr);
                } catch (parseError) {
                    console.error('JSON Parse Error:', JSON.stringify(parseError, null, 2), parseError);
                    throw new Error('Claude APIã®å¿œç­”ã‚’JSONã¨ã—ã¦è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
            }

            generatePrompt() {
                const memo = document.getElementById('memo-input').value.trim();
                const chapterName = document.getElementById('chapter-name-input').value.trim();
                
                if (!memo) {
                    alert('æˆæ¥­ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                if (!chapterName) {
                    alert('ãƒãƒ£ãƒ—ã‚¿ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                const prompt = `ä»¥ä¸‹ã®æˆæ¥­ãƒ¡ãƒ¢ã‹ã‚‰ã€15å•ã®1å•1ç­”å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
é¸æŠè‚¢å•é¡Œã¨ç©´åŸ‹ã‚å•é¡Œã‚’åŠã€…ç¨‹åº¦ã§æ··åœ¨ã•ã›ã¦ãã ã•ã„ã€‚
é¸æŠè‚¢å•é¡Œã¯4æŠã§ã€1ã¤ã®æ­£è§£ã¨3ã¤ã®é–“é•ã£ãŸé¸æŠè‚¢ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
ç©´åŸ‹ã‚å•é¡Œã¯é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç­”ãˆã¨ã—ã¦ãã ã•ã„ã€‚

å¯¾è±¡ãƒãƒ£ãƒ—ã‚¿ãƒ¼: ${chapterName}
æˆæ¥­ãƒ¡ãƒ¢:
${memo}

å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜æ–‡ã‚„è¿½åŠ ã®ãƒ†ã‚­ã‚¹ãƒˆã¯ä¸€åˆ‡ä¸è¦ï¼‰:
[
  {
    "type": "multiple",
    "question": "å•é¡Œæ–‡",
    "options": ["é¸æŠè‚¢1", "é¸æŠè‚¢2", "é¸æŠè‚¢3", "é¸æŠè‚¢4"],
    "correctAnswer": 0
  },
  {
    "type": "fillblank", 
    "question": "____ã«å…¥ã‚‹èªå¥ã¯ä½•ã§ã™ã‹ï¼Ÿ",
    "correctAnswer": "æ­£è§£ã®èªå¥"
  }
]`;

                document.getElementById('prompt-text').value = prompt;
                document.getElementById('prompt-display').classList.remove('hidden');
                document.getElementById('import-area').classList.add('hidden');
            }

            copyPrompt() {
                const promptText = document.getElementById('prompt-text');
                promptText.select();
                document.execCommand('copy');
                alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼Claude AIã«è²¼ã‚Šä»˜ã‘ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
            }

            showImportArea() {
                document.getElementById('import-area').classList.remove('hidden');
                document.getElementById('prompt-display').classList.add('hidden');
            }

            processImport() {
                const importText = document.getElementById('import-text').value.trim();
                const chapterName = document.getElementById('chapter-name-input').value.trim();
                
                if (!importText) {
                    alert('Claude AIã®å›ç­”ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
                    return;
                }

                if (!chapterName) {
                    alert('ãƒãƒ£ãƒ—ã‚¿ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                try {
                    let jsonStr = importText;
                    const jsonMatch = importText.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
                    if (jsonMatch) {
                        jsonStr = jsonMatch[1];
                    } else {
                        const arrayMatch = importText.match(/\[[\s\S]*\]/);
                        if (arrayMatch) {
                            jsonStr = arrayMatch[0];
                        }
                    }
                    
                    const questions = JSON.parse(jsonStr);
                    
                    if (!Array.isArray(questions)) {
                        throw new Error('å•é¡Œã¯é…åˆ—å½¢å¼ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                    }
                    
                    for (const q of questions) {
                        if (!q.type || !q.question) {
                            throw new Error('å•é¡Œã«type, questionãŒå¿…è¦ã§ã™');
                        }
                        if (q.type === 'multiple' && (!q.options || !q.hasOwnProperty('correctAnswer'))) {
                            throw new Error('é¸æŠè‚¢å•é¡Œã«ã¯options, correctAnswerãŒå¿…è¦ã§ã™');
                        }
                        if (q.type === 'fillblank' && !q.correctAnswer) {
                            throw new Error('ç©´åŸ‹ã‚å•é¡Œã«ã¯correctAnswerãŒå¿…è¦ã§ã™');
                        }
                    }

                    this.saveChapterData(chapterName, questions).then((result) => {
                        this.loadChaptersForSubject(this.currentSubject);
                        
                        document.getElementById('memo-input').value = '';
                        document.getElementById('chapter-name-input').value = '';
                        document.getElementById('import-text').value = '';
                        document.getElementById('import-area').classList.add('hidden');
                        document.getElementById('prompt-display').classList.add('hidden');
                        
                        alert(result.message);
                    });
                    
                } catch (error) {
                    alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}\n\nJSONå½¢å¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                }
            }

            startQuiz() {
                if (this.selectedChapters.length === 0) {
                    alert('å­¦ç¿’ã™ã‚‹ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                if (this.questions.length === 0) {
                    alert('é¸æŠã•ã‚ŒãŸãƒãƒ£ãƒ—ã‚¿ãƒ¼ã«å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }
                this.currentQuestionIndex = 0;
                this.isAnswered = false;
                document.getElementById('quiz-section').style.display = 'block';
                this.showQuestion();
            }

            showQuestion() {
                if (this.currentQuestionIndex >= this.questions.length) {
                    this.endQuiz();
                    return;
                }
                const question = this.questions[this.currentQuestionIndex];
                const chapterInfo = question.chapter ? ` (ãƒãƒ£ãƒ—ã‚¿ãƒ¼ ${question.chapter})` : '';
                document.getElementById('question-text').textContent = 
                    `å•é¡Œ ${this.currentQuestionIndex + 1}/${this.questions.length}${chapterInfo}: ${question.question}`;

                const optionsContainer = document.getElementById('options-container');
                const fillBlankInput = document.getElementById('fill-blank-input');
                const submitBtn = document.getElementById('submit-answer');
                const nextBtn = document.getElementById('next-question');

                optionsContainer.innerHTML = '';
                fillBlankInput.classList.add('hidden');
                submitBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
                this.isAnswered = false;

                if (question.type === 'multiple') {
                    question.options.forEach((option, index) => {
                        const btn = document.createElement('button');
                        btn.className = 'option-btn';
                        btn.textContent = option;
                        btn.addEventListener('click', () => this.selectOption(index, btn));
                        optionsContainer.appendChild(btn);
                    });
                } else if (question.type === 'fillblank') {
                    fillBlankInput.classList.remove('hidden');
                    fillBlankInput.value = '';
                    submitBtn.classList.remove('hidden');
                }
            }

            async selectOption(index, btnElement) {
                if (this.isAnswered) return;
                const question = this.questions[this.currentQuestionIndex];
                const correct = index === question.correctAnswer;

                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.style.pointerEvents = 'none';
                });

                if (correct) {
                    btnElement.classList.add('correct');
                    this.score++;
                } else {
                    btnElement.classList.add('incorrect');
                    document.querySelectorAll('.option-btn')[question.correctAnswer].classList.add('correct');
                }

                this.totalQuestions++;
                this.isAnswered = true;
                await this.updateChapterScore(question.chapter, correct);
                this.updateUI();
                document.getElementById('next-question').classList.remove('hidden');
            }

            async submitAnswer() {
                if (this.isAnswered) return;
                const userAnswer = document.getElementById('fill-blank-input').value.trim();
                const question = this.questions[this.currentQuestionIndex];

                if (!userAnswer) {
                    alert('ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                const correct = userAnswer.toLowerCase() === question.correctAnswer.toLowerCase();
                if (correct) {
                    alert('æ­£è§£ï¼');
                    this.score++;
                } else {
                    alert(`ä¸æ­£è§£ã€‚æ­£è§£ã¯ã€Œ${question.correctAnswer}ã€ã§ã™ã€‚`);
                }

                this.totalQuestions++;
                this.isAnswered = true;
                await this.updateChapterScore(question.chapter, correct);
                this.updateUI();

                document.getElementById('submit-answer').classList.add('hidden');
                document.getElementById('next-question').classList.remove('hidden');
            }

            async updateChapterScore(chapter, isCorrect) {
                try {
                    const userId = getUserId();

                    let fetchQuery = supabaseClient
                        .from('study_data')
                        .select('score, total_questions')
                        .eq('user_id', userId)
                        .eq('subject', this.currentSubject);
                    if (chapterColumnExists) {
                        fetchQuery = fetchQuery.eq('chapter', chapter);
                    }
                    const { data, error: fetchError } = await fetchQuery.single();
                    if (fetchError) throw fetchError;

                    const newScore = (data.score || 0) + (isCorrect ? 1 : 0);
                    const newTotal = (data.total_questions || 0) + 1;

                    let updateQuery = supabaseClient
                        .from('study_data')
                        .update({
                            score: newScore,
                            total_questions: newTotal,
                            updated_at: new Date().toISOString()
                        })
                        .eq('user_id', userId)
                        .eq('subject', this.currentSubject);
                    if (chapterColumnExists) {
                        updateQuery = updateQuery.eq('chapter', chapter);
                    }
                    const { error: updateError } = await updateQuery;
                    if (updateError) throw updateError;
                } catch (error) {
                    console.error('ã‚¹ã‚³ã‚¢æ›´æ–°ã‚¨ãƒ©ãƒ¼:', JSON.stringify(error, null, 2), error);
                }
            }

            nextQuestion() {
                this.currentQuestionIndex++;
                this.showQuestion();
            }

            endQuiz() {
                document.getElementById('quiz-section').style.display = 'none';
                const percentage = Math.round((this.score / this.totalQuestions) * 100);
                alert(`å­¦ç¿’å®Œäº†ï¼æ­£è§£ç‡: ${percentage}%`);
            }

            resetProgress() {
                if (this.selectedChapters.length === 0) {
                    alert('ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                if (confirm(`é¸æŠã•ã‚ŒãŸãƒãƒ£ãƒ—ã‚¿ãƒ¼ã®é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ`)) {
                    this.resetSelectedChaptersProgress();
                }
            }

            async resetSelectedChaptersProgress() {
                try {
                    const userId = getUserId();

                    if (chapterColumnExists) {
                        // chapteråˆ—ã‚ã‚Š: ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã”ã¨ã«å€‹åˆ¥ãƒªã‚»ãƒƒãƒˆ
                        for (const chapter of this.selectedChapters) {
                            const { error } = await supabaseClient
                                .from('study_data')
                                .update({
                                    score: 0,
                                    total_questions: 0,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('user_id', userId)
                                .eq('subject', this.currentSubject)
                                .eq('chapter', chapter);
                            if (error) throw error;
                        }
                    } else {
                        // chapteråˆ—ãªã—: subjectå…¨ä½“ã§ä¸€æ‹¬ãƒªã‚»ãƒƒãƒˆ
                        const { error } = await supabaseClient
                            .from('study_data')
                            .update({
                                score: 0,
                                total_questions: 0,
                                updated_at: new Date().toISOString()
                            })
                            .eq('user_id', userId)
                            .eq('subject', this.currentSubject);
                        if (error) throw error;
                    }
                    await this.loadSelectedChaptersData();
                    await this.loadChaptersForSubject(this.currentSubject);
                    this.updateUI();
                    alert('é¸æŠã•ã‚ŒãŸãƒãƒ£ãƒ—ã‚¿ãƒ¼ã®é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
                } catch (error) {
                    console.error('é€²æ—ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', JSON.stringify(error, null, 2), error);
                    alert('é€²æ—ãƒªã‚»ãƒƒãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            }

            showQuestionList() {
                const listElement = document.getElementById('question-list');
                if (listElement.classList.contains('hidden')) {
                    listElement.innerHTML = '';
                    this.questions.forEach((q, index) => {
                        const item = document.createElement('div');
                        item.className = 'question-item';
                        const chapterInfo = q.chapter ? ` [ãƒãƒ£ãƒ—ã‚¿ãƒ¼ ${q.chapter}]` : '';
                        item.innerHTML = `
                            <strong>Q${index + 1}${chapterInfo}:</strong> ${q.question}
                            <button class="delete-btn" onclick="app.deleteQuestion(${index})">å‰Šé™¤</button>
                        `;
                        listElement.appendChild(item);
                    });
                    listElement.classList.remove('hidden');
                } else {
                    listElement.classList.add('hidden');
                }
            }

            deleteQuestion(index) {
                if (confirm('ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    this.questions.splice(index, 1);
                    this.updateUI();
                    this.showQuestionList();
                }
            }

            clearSubjectData() {
                if (confirm(`${this.currentSubject}ã®ã™ã¹ã¦ã®ãƒãƒ£ãƒ—ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    this.clearAllChaptersData();
                }
            }

            async clearAllChaptersData() {
                try {
                    const userId = getUserId();
                    const { error } = await supabaseClient
                        .from('study_data')
                        .delete()
                        .eq('user_id', userId)
                        .eq('subject', this.currentSubject);
                    if (error) throw error;

                    this.selectedChapters = [];
                    this.allChapters[this.currentSubject] = [];
                    this.questions = [];
                    this.score = 0;
                    this.totalQuestions = 0;
                    this.updateUI();
                    this.displayChapterSelector();
                    document.getElementById('question-list').classList.add('hidden');
                    alert(`${this.currentSubject}ã®ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', JSON.stringify(error, null, 2), error);
                    alert('ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            }

            manageAPIKey() {
                const currentKey = localStorage.getItem('anthropic_api_key');
                let message = 'Anthropic APIã‚­ãƒ¼ç®¡ç†\n\n';
                if (currentKey) {
                    message += `ç¾åœ¨ã®ã‚­ãƒ¼: ${currentKey.substring(0, 10)}...\n\n`;
                    message += '1. æ–°ã—ã„ã‚­ãƒ¼ã‚’å…¥åŠ›\n2. ã‚­ãƒ¼ã‚’å‰Šé™¤\n3. ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
                    const choice = prompt(message + '\n\né¸æŠã—ã¦ãã ã•ã„ (1/2/3):');
                    if (choice === '1') {
                        const newKey = prompt('æ–°ã—ã„Anthropic APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                        if (newKey) {
                            localStorage.setItem('anthropic_api_key', newKey);
                            alert('APIã‚­ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
                        }
                    } else if (choice === '2') {
                        if (confirm('APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                            localStorage.removeItem('anthropic_api_key');
                            alert('APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
                        }
                    }
                } else {
                    const newKey = prompt('Anthropic APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                    if (newKey) {
                        localStorage.setItem('anthropic_api_key', newKey);
                        alert('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                    }
                }
            }

            showDebugInfo() {
                const apiKey = localStorage.getItem('anthropic_api_key');
                let debug = '=== ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===\n\n';
                debug += `ç¾åœ¨ã®ç§‘ç›®: ${this.currentSubject || 'ãªã—'}\n`;
                debug += `é¸æŠã•ã‚ŒãŸãƒãƒ£ãƒ—ã‚¿ãƒ¼: ${this.selectedChapters.join(', ') || 'ãªã—'}\n`;
                debug += `APIã‚­ãƒ¼: ${apiKey ? `è¨­å®šæ¸ˆã¿ (${apiKey.substring(0, 10)}...)` : 'æœªè¨­å®š'}\n`;
                debug += `å•é¡Œæ•°: ${this.questions.length}\n`;
                debug += `æ­£è§£/ç·å•é¡Œ: ${this.score}/${this.totalQuestions}\n`;
                debug += `ç”»é¢å¹…: ${window.innerWidth}px\n`;
                debug += `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: ${navigator.userAgent.includes('Mobile') ? 'ãƒ¢ãƒã‚¤ãƒ«' : 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—'}\n\n`;
                debug += '=== UIè¡¨ç¤ºçŠ¶æ…‹ ===\n';
                debug += `generate-section: ${document.getElementById('generate-section').classList.contains('hidden') ? 'éè¡¨ç¤º' : 'è¡¨ç¤º'}\n`;
                debug += `study-section: ${document.getElementById('study-section').classList.contains('hidden') ? 'éè¡¨ç¤º' : 'è¡¨ç¤º'}\n`;
                debug += `chapter-section: ${document.getElementById('chapter-section').classList.contains('hidden') ? 'éè¡¨ç¤º' : 'è¡¨ç¤º'}\n`;
                debug += `management-section: ${document.getElementById('management-section').classList.contains('hidden') ? 'éè¡¨ç¤º' : 'è¡¨ç¤º'}\n\n`;
                debug += '=== ãƒãƒ£ãƒ—ã‚¿ãƒ¼æƒ…å ± ===\n';
                if (this.currentSubject && this.allChapters[this.currentSubject]) {
                    this.allChapters[this.currentSubject].forEach(chapter => {
                        debug += `${chapter.chapter}: ${chapter.questions ? chapter.questions.length : 0}å•\n`;
                    });
                }
                alert(debug);
            }

            async saveToCloud() {
                try {
                    const button = document.getElementById('save-to-cloud');
                    button.disabled = true;
                    button.textContent = 'ä¿å­˜ä¸­...';
                    const userId = getUserId();
                    let migratedCount = 0;
                    for (const subject of ['kigyoukeiei', 'shinrigaku']) {
                        const key = `study_app_${subject}`;
                        const localData = localStorage.getItem(key);
                        if (localData) {
                            const parsedData = JSON.parse(localData);
                            if (parsedData.questions && parsedData.questions.length > 0) {
                                const chapterName = `ç§»è¡Œãƒ‡ãƒ¼ã‚¿ - ${new Date().toLocaleDateString()}`;
                                const data = {
                                    user_id: userId,
                                    subject: subject,
                                    chapter: chapterName,
                                    questions: parsedData.questions,
                                    score: parsedData.score || 0,
                                    total_questions: parsedData.totalQuestions || 0,
                                    updated_at: new Date().toISOString()
                                };
                                const { error } = await supabaseClient
                                    .from('study_data')
                                    .upsert(data, { onConflict: 'user_id,subject,chapter' });
                                if (error) throw error;
                                migratedCount++;
                                localStorage.removeItem(key);
                            }
                        }
                    }
                    if (migratedCount > 0) {
                        alert(`ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå®Œäº†ï¼${migratedCount}ç§‘ç›®ã®ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ç§»è¡Œã—ã¾ã—ãŸã€‚`);
                    } else {
                        alert('ãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚');
                    }
                } catch (error) {
                    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', JSON.stringify(error, null, 2), error);
                    alert('ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                } finally {
                    const button = document.getElementById('save-to-cloud');
                    button.disabled = false;
                    button.textContent = 'ğŸ“¤ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜';
                }
            }

            async loadFromCloud() {
                try {
                    const button = document.getElementById('load-from-cloud');
                    button.disabled = true;
                    button.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
                    const userId = getUserId();
                    const { data, error } = await supabaseClient
                        .from('study_data')
                        .select('*')
                        .eq('user_id', userId);
                    if (error) throw error;
                    if (data.length === 0) {
                        alert('ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\nå…ˆã«ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã§å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    if (this.currentSubject) {
                        await this.loadChaptersForSubject(this.currentSubject);
                        this.updateUI();
                    }
                    alert(`ã‚¯ãƒ©ã‚¦ãƒ‰èª­ã¿è¾¼ã¿å®Œäº†ï¼${data.length}ä»¶ã®ãƒãƒ£ãƒ—ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚\n\nç§‘ç›®ã¨ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’é¸æŠã—ã¦å­¦ç¿’ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚`);
                } catch (error) {
                    console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', JSON.stringify(error, null, 2), error);
                    alert('èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                } finally {
                    const button = document.getElementById('load-from-cloud');
                    button.disabled = false;
                    button.textContent = 'ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿';
                }
            }

            exportData() {
                alert('æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚\nã€ŒğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ã€ã‚’ä½¿ç”¨ã—ã¦ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã§ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¦ãã ã•ã„ã€‚');
            }

            showDataImportArea() {
                alert('æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã€ã€ŒğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ã€ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¦ãã ã•ã„ã€‚');
            }

            processDataImport() {
                alert('æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã€ã€ŒğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ã€ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¦ãã ã•ã„ã€‚');
            }

            setUserId() {
                const newUserId = document.getElementById('user-id-input').value.trim();
                if (!newUserId) {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                if (newUserId.length < 3) {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯3æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                if (!/^[a-zA-Z0-9_-]+$/.test(newUserId)) {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯è‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚');
                    return;
                }
                const currentUserId = localStorage.getItem('study_app_user_id');
                if (currentUserId && currentUserId !== newUserId) {
                    if (!confirm(`ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€Œ${currentUserId}ã€ã‚’ã€Œ${newUserId}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ\n\næ³¨æ„: å¤‰æ›´å¾Œã¯ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã§ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`)) {
                        return;
                    }
                }
                localStorage.setItem('study_app_user_id', newUserId);
                this.updateUserIdDisplay();
                document.getElementById('user-id-input').value = '';
                alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ã€Œ${newUserId}ã€ã«è¨­å®šã—ã¾ã—ãŸï¼\n\nä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã‚‚åŒã˜IDã‚’è¨­å®šã—ã¦ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã‚’è¡Œã£ã¦ãã ã•ã„ã€‚`);
            }
        }

        // CDNã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’ç¢ºèªã—ã¦ã‹ã‚‰supabaseã‚’åˆæœŸåŒ–ã—ã€ã‚¢ãƒ—ãƒªã‚’èµ·å‹•
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚«ãƒ©ãƒ æ§‹æˆã‚’ç¢ºèªã—ã€chapteråˆ—ãŒã‚ã‚‹ã‹ã‚’æ¤œè¨¼ã™ã‚‹
        let chapterColumnExists = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§trueã€ç¢ºèªå¾Œã«å¤‰æ›´

        async function checkTableColumns() {
            try {
                // study_dataãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰1ä»¶ã ã‘å–å¾—ã—ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚­ãƒ¼ã‚’è¦‹ã‚‹
                const { data, error } = await supabaseClient
                    .from('study_data')
                    .select('*')
                    .limit(1);
                if (error) {
                    console.warn('ã‚«ãƒ©ãƒ ç¢ºèªã‚¯ã‚¨ãƒªã‚¨ãƒ©ãƒ¼:', JSON.stringify(error));
                    // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç©ºã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã¯ãš
                    // ã‚¨ãƒ©ãƒ¼ = ãƒ†ãƒ¼ãƒ–ãƒ«è‡ªä½“ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§
                    chapterColumnExists = false;
                    return;
                }
                if (data && data.length > 0) {
                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« chapter ã‚­ãƒ¼ãŒã‚ã‚‹ã‹ç¢ºèª
                    chapterColumnExists = 'chapter' in data[0];
                    console.log('chapteråˆ—å­˜åœ¨ç¢ºèª:', chapterColumnExists, 'ã‚«ãƒ©ãƒ :', Object.keys(data[0]));
                } else {
                    // ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ = ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å­˜åœ¨ã™ã‚‹ãŒãƒ‡ãƒ¼ã‚¿ãªã—
                    // ã“ã®å ´åˆã¯ chapter åˆ—ã®å­˜åœ¨ãŒåˆ†ã‹ã‚‰ãªã„ãŸã‚ã€ãƒ†ã‚¹ãƒˆç”¨ã« insert ã—ã¦ç¢ºèª
                    // ã—ã‹ã—æ¨©é™ã®å•é¡ŒãŒã‚ã‚‹ãŸã‚ã€ã¨ã‚Šã‚ãˆãš false ã¨ã™ã‚‹
                    console.warn('study_dataãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã€‚chapteråˆ—å­˜åœ¨ã¯ä¸æ˜ã€‚');
                    chapterColumnExists = false;
                }
            } catch (e) {
                console.error('ã‚«ãƒ©ãƒ ç¢ºèªã‚¨ãƒ©ãƒ¼:', JSON.stringify(e), e);
                chapterColumnExists = false;
            }
        }

        function initSupabase() {
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    global: {
                        fetch: (...args) => fetch(...args)
                    }
                });
                console.log('SupabaseåˆæœŸåŒ–å®Œäº†');
                // ã‚«ãƒ©ãƒ ç¢ºèªå¾Œã«ã‚¢ãƒ—ãƒªã‚’èµ·å‹•
                checkTableColumns().then(() => {
                    console.log('chapterColumnExists:', chapterColumnExists);
                    window.app = new StudyApp();
                });
            } else {
                console.warn('Supabase CDNæœªèª­ã¿è¾¼ã¿ã€‚å†è©¦è¡Œä¸­...');
                setTimeout(initSupabase, 200);
            }
        }
        document.addEventListener('DOMContentLoaded', initSupabase);
    </script>
</body>
</html>
